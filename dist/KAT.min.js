/**
Copyright (c) 2014-15 by the KWARC Group (http://kwarc.info)

KAT is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

KAT is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with KAT.  If not, see <http://www.gnu.org/licenses/>
*/

!function(a,b){b.KAT=a;var c=a,d=b.jQuery;c.rdf={},c.rdf.kat_namespace="https://github.com/KWARC/KAT/",c.rdf.rdf_namespace="http://www.w3.org/1999/02/22-rdf-syntax-ns#",c.rdf.create=function(a){return document.createElementNS(c.rdf.rdf_namespace,a)},c.rdf.attr=function(a,b,c){return d(a).get(0).setAttribute(b,c),a},c.rdf.resolveWithNameSpace=function(a,b){var c=a.split(":");if(2==c.length){var e=d(b).find("annotation").eq(0);return e.attr("xmlns:"+c[0])+c[1]}return a},c.rdf.buildNameSpace=function(a,b){for(var c,e,f,g=d(b).find("annotation").get(0)||d(b).get(0),h=0;h<g.attributes.length;h++)if(c=g.attributes[h],"xmlns"==c.name.substring(0,"xmlns".length)&&(e=c.name.split(":")[1]||"",a.startsWith(c.value)))return f=a.substring(c.value.length),""!==e?e+":"+f:f;return a},c.rdf.findById=function(a,b){return jQuery("rdf\\:Description",a).filter(function(){return jQuery(this).attr("rdf:nodeID")===b})},c.model={},c.model.nameRegExS="(?:\\w|\\d|\\-|\\_|\\+)+",c.model.nameRegEx=new RegExp("^"+c.model.nameRegExS+"$"),c.model.nameRegEx2=new RegExp("^("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")$"),c.model.nameRegEx3=new RegExp("^("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")$"),c.model.nameNormaliser=function(a){return a},c.model.ParsingError=function(a,b){var c=Error.apply(this,[a]);return c.name=this.name="KAT.model.ParsingError",c.node=this.node=b,b instanceof jQuery&&(c.node=this.node=b.toArray()),this.message=c.message,Object.defineProperty(this,"stack",{get:function(){return c.stack}}),this},function(){var a=function(){};a.prototype=Error.prototype,c.model.ParsingError.prototype=new a}(),c.model.KAnnSpecCollection=function(){this.KAnnSpecs=[]},c.model.KAnnSpecCollection.prototype.addKAnnSpec=function(a){return this.getKAnnSpec(a.name)?!1:(this.KAnnSpecs.push(a),a)},c.model.KAnnSpecCollection.prototype.addNewKAnnSpec=function(a,b){return this.addKAnnSpec(new c.model.KAnnSpec(a,b,this))},c.model.KAnnSpecCollection.prototype.init=function(){return d.each(this.KAnnSpecs,function(a,b){d.each(b.concepts,function(a,b){d.each(b.fields,function(){if(this.type==c.model.Field.types.reference)for(var a=0;a<this.validation.length;a++){var b=this.validation[a];b instanceof c.model.Concept&&(b=b.getFullName());var d=this.concept.KAnnSpec.getConcept(b);if(d||(d=this.concept.KAnnSpec.collection.getConcept(b)),!d)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Concept not found: '"+b+"'). ",this.xml);this.validation[a]=d}}.bind(b))}.bind(b))}),this},c.model.KAnnSpecCollection.prototype.getKAnnSpec=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.KAnnSpecs.length;b++)if(this.KAnnSpecs[b].name==a)return this.KAnnSpecs[b];return!1},c.model.KAnnSpecCollection.prototype.getConcept=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx2.test(a))return!1;a=a.match(c.model.nameRegEx2);var b=this.getKAnnSpec(a[1]);return b?b.getConcept(a[2]):!1},c.model.KAnnSpecCollection.prototype.findConcepts=function(){for(var a=[],b=0;b<this.KAnnSpecs.length;b++)for(var c=0;c<this.KAnnSpecs[b].concepts.length;c++)a.push(this.KAnnSpecs[b].concepts[c]);return a},c.model.KAnnSpecCollection.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx3.test(a))return!1;a=a.match(c.model.nameRegEx3);var b=this.getKAnnSpec(a[1]);if(!b)return!1;var d=b.getConcept(a[2]);return d?d.getField(a[3]):!1},c.model.KAnnSpecCollection.prototype.assignDisplayColour=function(){var a=function(a){var b="0123456789ABCDEF";return String(b.substr(a>>4&15,1))+b.substr(15&a,1)},b=function(b,c,d){return"#"+a(b)+a(c)+a(d)},c=function(a,c,d,e){for(var f=128,g=127,h=56,i=[],j=0;h>j;++j){var k=Math.sin(a*j+c)*g+f,l=Math.sin(a*j+d)*g+f,m=Math.sin(a*j+e)*g+f;i.push(b(k,l,m))}return i},d=function(a,b){for(var c=Math.floor(b/a),d=[],e=c;b>=e;)d.push(e),e=c+d[d.length-1];var f=Math.floor(b/2),g=d[Math.floor(d.length/2)],h=g-f;return d.length%2===0&&(h=Math.floor(h/2)),d.forEach(function(a,b){d[b]=a-h}),d},e=function(a){var b=c(.1,0,2,4),e=d(a,b.length),f=[];for(i=0;i<e.length;i++)f.push(b[e[i]]);return f},f=this.findConcepts(),g=f.length,h=e(g);for(i=0;i<g;i++)f[i].displayColour=h[i]},c.model.KAnnSpec=function(a,b,e){try{this.xml=jQuery(a)}catch(f){throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Unable to parse XML). ",this.xml)}if(1!=this.xml.children().length||!this.xml.children().eq(0).is("annotation"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Expected exactly one top-level <annotation>). ",this.xml);if(this.url=c.storage.resolve(b),this.name=c.model.nameNormaliser(this.xml.children().eq(0).attr("name")),this.rdf_nodeid="KAT_"+(new Date).getTime()+"_"+this.name,!this.name||!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.KAnnSpec: Unable to create KAnnSpec ('"+this.name+"' is not a valid name). ",this.xml);var g=this.xml.children().eq(0);if(g.children().length<=1||!g.children().eq(0).is("documentation"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected exactly one <documentation>). ",g);this.collection=e,this.documentation=g.children().eq(0).text().trim(),this.concepts=[],g.children().slice(1).each(function(a,b){if(b=d(b),!b.is("concept"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected child tag <concept>). ",b);this.concepts.push(new c.model.Concept(b,this))}.bind(this))},c.model.KAnnSpec.prototype.getFullName=function(){return this.name},c.model.KAnnSpec.prototype.getConcept=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.concepts.length;b++)if(this.concepts[b].name==a)return this.concepts[b];return!1},c.model.KAnnSpec.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx2.test(a))return!1;a=a.match(c.model.nameRegEx2);var b=this.getConcept(a[1]);return b?b.getField(a[2]):!1},c.model.Concept=function(a,b){try{this.xml=jQuery(a)}catch(d){throw new c.model.ParsingError("KAT.model.Concept: Invalid XML (Unable to parse XML). ",this.xml)}if(this.KAnnSpec=b,"string"!=typeof this.xml.attr("name"))throw new c.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing name attribute for <concept>). ",this.xml);if("string"!=typeof this.xml.attr("rdftype"))throw new c.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing rdftype attribute for <concept>). ",this.xml);if(this.name=c.model.nameNormaliser(this.xml.attr("name")),!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.KAnnSpec.getConcept(this.name))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML (Concept '"+this.getFullName()+"' already exists). ",this.xml);if(this.rdf_type=c.rdf.resolveWithNameSpace(this.xml.attr("rdftype"),this.KAnnSpec.xml),1!=this.xml.length||!this.xml.is("concept"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected exactly one <concept> tag). ",this.xml);this.documentation="",this.fields=[],this.displayColour="",this.display="";var e=this.xml.children(),f=0;if(e.length<2)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <field>, <display> and <rdf:rdf>). ",e);e.eq(f).is("documentation")&&(this.documentation=e.eq(f).text().trim(),f++);for(var g=!1;e.eq(f).is("field")&&f<e.length;)g=!0,this.fields.push(new c.model.Field(e.eq(f),this)),f++;if(!g)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing at least one declared <field>). ",e);if(!e.eq(f).is("display"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing required <display>). ",e);var h=e.eq(f);if(1!=h.children().length||!h.children().eq(0).is("template"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing <template>). ",h);if(this.display=h.children().html().trim(),f++,f<e.length){if("rdf:RDF"!=e.eq(f).prop("tagName"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected <rdf:rdf> in final position. ). ",e);this.rdf=e.eq(f).html().trim(),f++}if(f!=e.length)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <fields>, <display> and <rdf:RDF>). ",e)},c.model.Concept.prototype.getDefault=function(){var a={};return d.each(this.fields,function(b){b.type==c.model.Field.types.text?a[b.value]=b["default"]:b.type==c.model.Field.types.select?a[b.value]=""===b["default"]?b.validation[0]:b["default"]:b.type==c.model.Field.types.reference&&(a[b.value]="")}),a},c.model.Concept.prototype.getFullName=function(){return this.KAnnSpec.getFullName()+"."+this.name},c.model.Concept.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.fields.length;b++)if(this.fields[b].name==a)return this.fields[b];return!1},c.model.Field=function(a,b){try{this.xml=jQuery(a)}catch(e){throw new c.model.Field("KAT.model.Field: Invalid XML (Unable to parse XML). ",this.xml)}if(this.concept=b,"string"!=typeof this.xml.attr("name"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML (Missing name attribute for <field>). ",this.xml);if(this.name=c.model.nameNormaliser(this.xml.attr("name")),!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.Field: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.concept.getField(this.name))throw new c.model.ParsingError("KAT.model.Field: Invalid XML (Field '"+this.getFullName()+"' already exists). ",this.xml);if("string"!=typeof this.xml.attr("type"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing type attribute for <field>). ",this.xml);if("string"!=typeof this.xml.attr("rdfpred"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing rdfpred attribute for <field>). ",this.xml);if(!c.model.Field.types.hasOwnProperty(this.xml.attr("type")))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unknown <field> type). ",this.xml);this.type=c.model.Field.types[this.xml.attr("type")],this.rdf_pred=c.rdf.resolveWithNameSpace(this.xml.attr("rdfpred"),this.concept.KAnnSpec.xml),this.minimum=1,this.maximum=1,this.value="",this["default"]="",this.documentation="",this.validation=void 0;var f=!1,g=!1,h=!1,i=!1,j=!1;if(this.validation=this.type==c.model.Field.types.text?new RegExp(".*"):[],this.xml.children().each(function(a,b){if(b=d(b),b.is("value")){if(f)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <value> tag). ",b);f=!0,this.value=b.text()}else if(b.is("number")){if(i)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <number> tag). ",b);i=!0;try{this.minimum=parseInt(b.attr("atleast"))}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atleast property must be a number). ",b)}try{this.maximum=parseInt(b.attr("atmost"))}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atmost property must be a number). ",b)}}else if(b.is("documentation")){if(j)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <documentation> tag). ",b);j=!0,this.documentation=b.text().trim()}else if(b.is("default")&&this.type==c.model.Field.types.text){if(g)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <default> tag). ",b);g=!0,this["default"]=b.text()}else if(b.is("validation")&&this.type==c.model.Field.types.text){if(h)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <validation> tag). ",b);h=!0,this.validation=b.text(),"^"!=this.validation[0]&&(this.validation="^"+this.validation),"$"!=this.validation[this.validation.length-1]&&(this.validation=this.validation+"$");try{this.validation=new RegExp(this.validation)}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unregonised regular expression). ",b)}}else if(b.is("referencedType")&&this.type==c.model.Field.types.reference)this.validation.push(b.text());else if(b.is("option")&&this.type==c.model.Field.types.select)this.validation.push(new c.model.Option(b,this));else{if(!b.is("defaultoption")||this.type!=c.model.Field.types.select)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unexpected tag '"+b.prop("tagName")+"'). ",b);this.validation.push(new c.model.Option(b,this))}}.bind(this)),f||(this.value=this.name),this.type==c.model.Field.types.select&&0===this.validation.length)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (KAT.model.Field.types.select must have a non-empty list of options. ). ",e);for(var k=0;k<this.concept.fields.length;k++)if(this.concept.fields[k].value==this.value)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Value '"+this.value+"' already used by field '"+this.concept.fields[k].getFullName()+"'). ",this.xml)},c.model.Field.prototype.getFullName=function(){return this.concept.getFullName()+"."+this.name},c.model.Field.types={reference:"reference",select:"select",text:"text"},c.model.Option=function(a,b){try{this.xml=jQuery(a)}catch(d){throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Unable to parse XML). ",this.xml)}if(this.field=b,1!=this.xml.find("value").length)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Expected exactly one <value>. )",this.xml);this.value=this.xml.find("value").text();for(var e=0;e<this.field.validation.length;e++)if(this.field.validation[e].value==this.value)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Value '"+this.value+"' already used). ",this.xml);if(this.xml.is("defaultoption")){if(""!==this.field["default"])throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Default already exists)",this.xml);this.field["default"]=this.value}if(this.rdf_obj=!1,"string"==typeof this.xml.attr("rdfobj")&&(this.rdf_obj=c.rdf.resolveWithNameSpace(this.xml.attr("rdfobj"),this.field.concept.KAnnSpec.xml)),this.documentation=this.xml.find("documentation").text(),this.xml.children().length>2)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Too many children. )",this.xml)},c.gui=function(a,b){b.init(),this.collection=b,this.element=a},c.gui.prototype.getSelection=function(){var a=window.getSelection().getRangeAt(0),b=this.element,d=function(a){return 3==a.nodeType?a.parentElement:a},e=c.gui.getXPath(b,d(a.commonAncestorContainer)),f=c.gui.getXPath(b,d(a.startContainer)),g=c.gui.getXPath(b,d(a.endContainer)),h={container:e,start:f,startOffset:a.startOffset,end:g,endOffset:a.endOffset,isEmpty:!1};return f==g&&a.startOffset==a.endOffset&&(h.isEmpty=!0),h},c.gui.getXPath=function(a,b){var c=d(b).get(0),e=d(a).get(0);if(c.hasAttribute("id"))return"//*[@id='"+c.id+"']";for(var f=[];c&&c!==e;c=c.parentNode){for(var g=0,h=c.previousSibling;h;h=h.previousSibling)h.nodeType!=Node.DOCUMENT_TYPE_NODE&&h.nodeName==c.nodeName&&++g;var i=c.nodeName.toLowerCase(),j=g?"["+(g+1)+"]":"";f.splice(0,0,i+j)}return f.length?"/"+f.join("/"):null},c.gui.resolveXPath=function(a,b){var c=b.match(/^\/\/\*\[@id='([^']+)'\]$/);if(c)return document.getElementById(c[1]);for(var e,f,g,h,i=d(a).get(0),j=b.split("/").splice(1),k=function(a){return(a.tagName||a.nodeName).toLowerCase()==f.toLowerCase()},l=0;l<j.length;l++)if(e=j[l],f=e.split("[")[0],g=parseInt((e.split("[")[1]||"1]").split("]")[0])-1,h=i,i=Array.prototype.filter.call(i.children,k)[g],void 0===i)return void console.log("undefined",h,e,f,g);return i},c.gui.prototype.getRange=function(a){var b=d(c.gui.resolveXPath(this.element,a.container)),e=b.find("*").andSelf(),f=e.index(c.gui.resolveXPath(this.element,a.start)),g=d(c.gui.resolveXPath(this.element,a.end)),h=e.index(g);return e=e.slice(f,h),e.filter(function(a,b){var c=d(b).children();return c.length==e.filter(c).length}).add(g.find("*").andSelf())},c.gui.nodeInRange=function(a,b){var c;if(a.intersectsNode)return a.intersectsNode(b);c=b.ownerDocument.createRange();try{c.selectNode(b)}catch(d){c.selectNodeContents(b)}return-1==a.compareBoundaryPoints(Range.END_TO_START,c)&&1==a.compareBoundaryPoints(Range.START_TO_END,c)},c.gui.dialog=function(a,b,c,e){var f={},g=d([]);d.each(c,function(a){g=g.add(d("<button class='btn btn-"+(0===a?"primary":"default")+"'>").text(c[a]).click(function(){e.call(f,c[a],a)}))}),g=d(g.get().reverse());var h=d('<h4 class="modal-title"></h4>').text(a),i=d("<p>").text(b),j=d('<div class="modal fade">').append(d('<div class="modal-dialog">').append(d('<div class="modal-content">').append(d('<div class="modal-header>').append(d('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>').click(function(){return e.call(f,"",-1),!1}),h),d('<div class="modal-body">').append(i),d('<div class="modal-footer">').append(g))));return j.appendTo(d("<div>").appendTo("body")).modal(),f={$dialog:j,$title:h,$content:i,$buttons:g,close:function(){j.one("hidden.bs.modal",function(){j.remove()}).modal("hide")}}},c.gui.selectDialog=function(a,b,e,f,g){var h,i=0;if("function"==typeof f&&"undefined"==typeof g&&(g=f,f=function(){return""}),Array.isArray(f)){var j=f;f=function(a,b){return j[b]}}$self=c.gui.dialog(a,b,["OK","Cancel"],function(a,b){$self.close(),0===b?g.call($self,e[i],i):g.call($self,"",-1)});var k=d("<span>"),l=d("<span style='margin-left: 10px; '>"),m=d('<ul class="dropdown-menu" role="menu">'),n=d("<div class='dropdown'>").append(d('<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">').append(k,'<span class="caret"></span>'),m,l);return d.each(e,function(a,b){m.append(d('<li role="presentation">').append(d('<a role="menuitem" tabindex="-1" href="#">').text(b).click(function(){i=a,h()})))}),$self.$content.empty().append(d("<h3>").text(b),n),h=function(){k.text(e[i]),l.text(f(e[i],i))},h(),$self},c.sidebar={},c.sidebar.init=function(a,b){c.sidebar.store=a,c.sidebar.reviewStore=b;var e,f=function(){var e=JSON.stringify({store:a.toRDF(),annotations:b.toJSON()}),f="id="+c.sidebar.jobID+"&content="+e;d.post("http://localhost:4000/dumps",f,function(a){a.success===!0?(console.log("Posted annotations and reviews"),d(".contactServer").text("Request new document"),d(".contactServer").off("click"),d(".contactServer").click(g)):window.alert("The document couldn't be posted to the server.")})},g=function(){d.get("http://localhost:4000/get_task",function(e,f){function g(){console.log("Retrieving and parsing new document"),d.get("http://localhost:4000/"+e.path,function(f){var g="text/xml"==f.contentType||void 0;g&&(f=(new XMLSerializer).serializeToString(f)),a.clear(),b.clear(),d("#content").html(f),d(i).remove(),c.sidebar.annotationMode="Reading",c.sidebar.jobID=e.id,c.sidebar.init(a,b)})}"success"==f?g():window.alert("Couldn't reach CorTeX")},"json")};switch(c.sidebar.annotationMode){case"Review":e="Review";break;case"Annotation":e="Annotation";break;default:e="Reading"}var h=jQuery(window).height();c.sidebar.modeButtonGroup=d("<div>").addClass("btn-group").attr("role","group"),["Reading","Annotation","Review"].map(function(a){var b="";a==e&&(b="active"),d("<button>").attr("type","button").attr("mode",a).addClass("btn btn-default").addClass(b).text(a).click(function(){c.sidebar.toggleAnnotationMode(a)}).appendTo(c.sidebar.modeButtonGroup)});var i=jQuery("<div>").addClass("collapsible").append(d("<div>").addClass("KATTitle").html("<h3>KWARC Annotation Tool</h3>"),d("<div>").addClass("KATSidebarButtons").append(c.sidebar.modeButtonGroup,"<br/>","<br/>",d("<button>").text(c.sidebar.jobID?"Send document to server":"Request new document").addClass("helpButton contactServer").addClass("btn btn-default").click(function(){c.sidebar.jobID?f():g()}),"<br/>","<br/>",d("<button>").text("Import Annotations").addClass("helpButton").addClass("btn btn-default").click(function(){a.showImportDialog()}),"<br/>","<br/>",d("<button>").text("Export Annotations").addClass("helpButton").addClass("btn btn-default").click(function(){a.showExportDialog()}),"<br/>","<br/>",d("<button>").text("Import Reviews").addClass("helpButton").addClass("btn btn-default").click(function(){b.importReviews()}),"<br/>","<br/>",d("<button>").text("Export Reviews").addClass("helpButton").addClass("btn btn-default").click(function(){b.exportReviews()}),"<br/>","<br/>",d("<button>").text("Report Issue").addClass("helpButton").addClass("btn btn-default").click(function(){window.open("https://github.com/KWARC/KAT/issues","_blank")}),"<br/>","<br/>","<br/>"),d("<ul>").addClass("KATMenuItems")).css({position:"fixed",right:c.sidebar.hideWidth,height:h}).prependTo("body"),j=d("<button>").text("«").addClass("collapseToggle").css({height:h-20,"z-index":100}).click(c.sidebar.toggleSidebar).prependTo(i);c.sidebar.showSidebar(),jQuery(window).resize(function(){h=jQuery(window).height(),i.css({position:"fixed",right:c.sidebar.hideWidth,height:h}),j.css({height:h-20})})},c.sidebar.showSidebar=function(){c.sidebar.extended=!0,jQuery(".collapseToggle").text("»").parent().animate({right:"0"},c.sidebar.animateLength)},c.sidebar.hideSidebar=function(){c.sidebar.extended=!1,jQuery(".collapseToggle").text("«").parent().animate({right:c.sidebar.hideWidth},c.sidebar.animateLength)},c.sidebar.toggleSidebar=function(){c.sidebar.extended?c.sidebar.hideSidebar():c.sidebar.showSidebar()},c.sidebar.toggleAnnotationMode=function(a){"Review"==c.sidebar.annotationMode&&(c.storage.Annotation.prototype.unfocus(),c.sidebar.removeReviewForm()),c.sidebar.annotationMode=a,c.sidebar.modeButtonGroup.find(".active").removeClass("active"),c.sidebar.modeButtonGroup.find("[mode='"+a+"']").addClass("active"),"Review"==a&&c.sidebar.generateReviewForm()},c.sidebar.extended=!1,c.sidebar.annotationMode=!1,c.sidebar.hideWidth=-480,c.sidebar.animateLength=100,c.sidebar.modeButtonGroup=void 0,c.sidebar.generateAnnotationReferenceField=function(a,b,c,e,f,g){function h(e){if(j>k){e=e||!1,m=d("<div class='btn-group' role='group'>").appendTo(l),newField=jQuery("<select>").addClass("form-control").appendTo(m);var f=b.store.filterByConcept.apply(b.store,a.validation);if(jQuery.each(f,function(a,b){jQuery("<option>").text(b.uuid).val(b.uuid).appendTo(newField)}),d("<br>").appendTo(l),e){d("<button class='btn btn-default minusButton "+a.name+"' >").on("click",function(b){b.preventDefault();var e=d(b.target).parent();e.prev("br").remove(),e.remove(),c.find(".plusButton."+a.name).removeAttr("disabled"),k--,g()}).text("-").prependTo(m)}k++,k==j&&c.find(".plusButton."+a.name).attr("disabled","true"),g()}}var i=a.minimum||1,j=a.maximum||i,k=0,l=d("<div>").appendTo(c);f.push(function(){c.removeClass("has-success has-error");var a=c.find("select").eq(0).find("option").length>0;return c.addClass(a?"has-success":"has-error"),a});for(var m;i>k;)h();if(j>k&&d("<button class='btn btn-default plusButton "+a.name+"' >").on("click",function(a){a.preventDefault(),h(!0)}).text("+").prependTo(m),"undefined"!=typeof e)for(var n,o=e.values[a.value].slice(),p=0;0!==o.length;)n=o.shift(),p++,l.find("select").length<p&&h(!0),l.find("select").eq(p-1).val(n.uuid)},c.sidebar.generateAnnotationSelectField=function(a,b,c,e,f){function g(c){if(i>j){if(c=c||!1,l=d("<div class='btn-group' role='group'>").appendTo(k),newField=jQuery("<select>").addClass("form-control").appendTo(l),jQuery.each(a.validation,function(a,b){jQuery("<option>").text(b.value).val(a).appendTo(newField)}),d("<br>").appendTo(k),c){d("<button class='btn btn-default minusButton "+a.name+"' >").on("click",function(c){c.preventDefault();var e=d(c.target).parent();e.prev("br").remove(),e.remove(),b.find(".plusButton."+a.name).removeAttr("disabled"),j--,f()}).text("-").prependTo(l)}j++,j==i&&b.find(".plusButton."+a.name).attr("disabled","true"),f()}}var h=a.minimum||1,i=a.maximum||h,j=0,k=d("<div>").appendTo(b);e.push(function(){return b.addClass("has-success"),!0});for(var l;h>j;)g();if(i>j&&d("<button class='btn btn-default plusButton "+a.name+"' >").on("click",function(a){a.preventDefault(),g(!0)}).text("+").prependTo(l),"undefined"!=typeof c)for(var m,n=c.values[a.value].slice(),o=0;0!==n.length;){m=n.shift(),o++,k.find("select").length<o&&g(!0);for(var p=k.find("select").eq(o-1),q=0;q<a.validation.length;q++)a.validation[q].value===m.value&&p.val(q)}},c.sidebar.generateAnnotationTextField=function(a,b,c,e,f){function g(c){if(i>j){c=c||!1,m=d("<div>").addClass("input-group").appendTo(k),d("<input type='text'>").addClass("tfield").addClass("form-control").appendTo(m).keyup(function(){f()});{var e=d("<span>").addClass("input-group-btn").appendTo(m),g="<p>"+a.documentation+"</p><p>You are expected to match the following Regular Expression: </br>"+l+"</p>";d("<button type='button' class='btn btn-default'>").attr("title","Information").text("?").popover({html:!0,toggle:"popover",placement:"top",content:g,container:"#"+a.name}).appendTo(e)}if(d("<br>").appendTo(k),c){var h=d("<span class='input-group-btn'>").prependTo(m);d("<button class='btn btn-default minusButton "+a.name+"' >").on("click",function(c){c.preventDefault();var e=d(c.target).parent().parent();e.prev("br").remove(),e.remove(),b.find(".plusButton."+a.name).removeAttr("disabled"),j--,f()}).text("-").appendTo(h)}j++,j==i&&b.find(".plusButton."+a.name).attr("disabled","true"),f()}}var h=a.minimum||1,i=a.maximum||h,j=0,k=d("<div>").appendTo(b),l=a.validation;e.push(function(){var a=!0;return k.children().each(function(){var b=d(this),c=b.find("input[type=text]");0!==c.length&&(b.removeClass("has-success has-error"),l.test(c.val())?(b.addClass("has-success"),a=a&&!0):(b.addClass("has-error"),a=!1))}),a});for(var m;h>j;)g();if(i>j&&d("<span class='input-group-btn'>").append(d("<button class='btn btn-default plusButton "+a.name+"' >").on("click",function(a){a.preventDefault(),g(!0)}).text("+")).prependTo(m),"undefined"!=typeof c)for(var n,o=c.values[a.value].slice(),p=0;0!==o.length;)n=o.shift(),p++,k.find('input[type="text"]').length<p&&g(!0),k.find('input[type="text"]').eq(p-1).val(n)},c.sidebar.generateAnnotationForm=function(a,b,e,f,g){c.sidebar.extended||c.sidebar.toggleSidebar();var h,i;"undefined"==typeof e?i="Enter":(i="Edit",h=e.values);var j=d("<li>").append("<h4> "+g.name+" - "+i+" Annotation Details</h4>").appendTo(".KATMenuItems"),k=[],l=function(){var a=!0;return jQuery.each(k,function(b,c){a=a&&c()}),a?o.removeAttr("disabled"):o.attr("disabled","disabled"),a},m=d("<form>").addClass("form-inline").appendTo(j).on("submit",function(a){return a.preventDefault(),o.click(),!1}),n=d("<div>").addClass("btn-group"),o=d("<button type='submit'>").addClass("btn btn-primary").text("Save").click(function(h){if(h.preventDefault(),l()){var i={};d.each(g.fields,function(b,e){var f=p[b];i[e.value]=e.type==c.model.Field.types.reference?f.find("select").map(function(){return a.store.find(d(this).val())}).get().slice():e.type==c.model.Field.types.select?f.find("select").map(function(){return e.validation[d(this).val()]}).get().slice():f.find("input[type=text]").map(function(){return d(this).val()}).get().slice()}),d(".popover").popover("destroy").remove(),j.remove();var k=b(f,g,i,e);return k.draw(),!1}}).appendTo(n),p=(d("<button type='button'>").addClass("btn btn-danger").text("Cancel").click(function(){d(".popover").popover("destroy").remove(),j.remove()}).appendTo(n),jQuery.map(g.fields,function(b){var f=d("<div>").appendTo(m),g=d("<div id='"+b.name+"'>").addClass("form-group").appendTo(f).css({overflow:"auto"}).append(d("<label>").addClass("control-label").text(b.value),"&nbsp;");return b.type===c.model.Field.types.text?c.sidebar.generateAnnotationTextField(b,g,e,k,l):b.type===c.model.Field.types.select?c.sidebar.generateAnnotationSelectField(b,g,e,k,l):b.type===c.model.Field.types.reference&&c.sidebar.generateAnnotationReferenceField(b,a,g,e,k,l),f}));m.append("<br />",n),l()},c.sidebar.generateReviewForm=function(){var a,b=-1,c=this.store.annotations;if(0!==c.length){var e=function(){var d=c[b%c.length].recomputeTooltip();a.html(d)},f=function(){c[0].unfocus()||void 0;c[++b%c.length].focus(),e(),o()},g=function(){c[0].unfocus()||void 0;0>=b&&(b+=c.length),c[--b%c.length].focus(),e(),o()},h=d("<li>").addClass("review navigation").appendTo(".KATMenuItems");a=d("<div>").addClass("annotationText").appendTo(h);var i=d("<div>").addClass("btn-group").appendTo(h),j=(d("<button>").text("Next").addClass("btn btn-default").click(function(){f()}).appendTo(i),d("<button>").text("Previous").addClass("btn btn-default").click(function(){g()}).appendTo(i),d("<div>").addClass("btn-group").appendTo(h)),k=d("<button>").addClass("btn btn-default like").click(function(){n(),k.addClass("btn-success"),l.annotationReviews[c[b%c.length].uuid]="approve"}).appendTo(j);d("<span>").addClass("glyphicon glyphicon-thumbs-up").appendTo(k);var l=this.reviewStore,m=d("<button>").addClass("btn btn-default dislike").click(function(){n(),m.addClass("btn-danger"),l.annotationReviews[c[b%c.length].uuid]="disapprove"}).appendTo(j);d("<span>").addClass("glyphicon glyphicon-thumbs-down").appendTo(m);var n=function(){h.find("button").removeClass("btn-danger btn-success")},o=function(){n(),"approve"==l.annotationReviews[c[b%c.length].uuid]?k.addClass("btn-success"):"disapprove"==l.annotationReviews[c[b%c.length].uuid]&&m.addClass("btn-danger")};f()}},c.sidebar.removeReviewForm=function(){var a=d(".review.navigation");a&&a.remove()},c.storage={},c.storage.resolve=function(a,b,c){var d,e,f,g=!1;"string"==typeof b&&(g=!0,d=arguments.callee(b,!0),e=jQuery("base").detach(),f=jQuery("<base>").attr("href",d).appendTo("head"));var h=document.createElement("div");h.innerHTML='<a href="'+jQuery("<span/>").text(a).html()+'">x</a>';var i=h.firstChild.href;return g&&(f.remove(),e.appendTo("head")),b!==!0&&c!==!0||"/"==i[i.length-1]||(i+="/"),i},c.storage.Store=function(a,b){this.collection=a.collection,this.gui=a,this.docURL=c.storage.resolve(b),this.annotations=[]},c.storage.Store.prototype.clear=function(){this.annotations=[]},c.storage.Store.prototype.addNew=function(a,b,d){for(var e=new c.storage.Annotation(this,a,b,d),f=0,g=0;g<this.annotations.length;g++)this.gui.getRange(this.annotations[g].selection).stop()[0].offsetTop<this.gui.getRange(a).stop()[0].offsetTop&&f++;return this.annotations.splice(f,0,e),e},c.storage.Store.prototype.addFromJSON=function(a){var b=new c.storage.Annotation(this,c.storage.Store.UUID2Selection(a.uuid),this.collection.getConcept(a.concept));return b.values=a.values,this.annotations.push(b),b},c.storage.Store.prototype.filterByConcept=function(){var a=[],b=jQuery.makeArray(arguments),c=0===b.length;return jQuery.each(this.annotations,function(d,e){(c||-1!=b.indexOf(e.concept.name))&&a.push(e)}),a},c.storage.Store.prototype.find=function(a){for(var b=0;b<this.annotations.length;b++)if(this.annotations[b].uuid==a)return this.annotations[b];return void 0},c.storage.Store.prototype.findfromElement=function(a){for(var b=d(a).parentsUntil(this.element).andSelf().add(this.element),c=[],e=[],f=b.length-1;f>=0;f--)for(var g=b.eq(f).data("KAT.Annotation.UUID")||[],h=0;h<g.length;h++)-1==c.indexOf(g[h])&&(c.push(g[h]),e.push(this.find(g[h])));return e},c.storage.Store.prototype.updateReferences=function(){var a=this;

jQuery.map(this.annotations,function(b){jQuery.map(b.concept.fields,function(d){d.type===c.model.Field.types.reference&&jQuery.map(b.values[d.value],function(c,e){"string"==typeof c&&(b.values[d.value][e]=a.find(c))})})})},c.storage.Store.prototype.toRDF=function(){var a=this,b=d(c.rdf.create("rdf:RDF")).attr("xmlns:kat",c.rdf.kat_namespace).attr("xmlns:rdf",c.rdf.rdf_namespace),e="kat_run";b.append(d(c.rdf.create("rdf:Description")).append(c.rdf.attr(d(c.rdf.create("kat:annotation")),"rdf:nodeID",e)),c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",e).append(c.rdf.attr(d(c.rdf.create("rdf:type")),"rdf:resource","kat:run"),c.rdf.attr(d("<kat:date />").text((new Date).toISOString()),"rdf:datatype","xs:dateTime"),d("<kat:tool>").text("KAT"),d("<kat:runid>").text("0")));var f={};jQuery.each(this.annotations,function(g,h){var i=h.concept.KAnnSpec;f[i.rdf_nodeid]||(f[i.rdf_nodeid]=!0,i.xml.find("annotation").each(function(){d.each(this.attributes,function(a,c){var d=c.name,e=c.value;d.startsWith("xmlns:")&&b.attr(d,e)})}),b.append(d(c.rdf.create("rdf:Description")).append(c.rdf.attr(d(c.rdf.create("kat:annotation")),"rdf:nodeID",i.rdf_nodeid)),c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",i.rdf_nodeid).append(c.rdf.attr(d("<rdf:type>"),"rdf:resource","kat:kannspec"),d("<kat:kannspec-name>").text(i.name),d("<kat:kannspec-URI>").text(i.url)))),b.append(d(h.toRDF(a.docURL,e)).children())});var g=b.get(0).outerHTML;return g},c.storage.Store.prototype.addFromRDF=function(a){var b=this,d=jQuery(a),e=jQuery("rdf\\:Description",d).has("kat\\:annotates").map(function(){var a=c.storage.Annotation.fromRDF(d,jQuery(this).attr("rdf:nodeId"),b);return b.annotations.push(a),a}).toArray();return this.updateReferences(),e},c.storage.Store.prototype.showExportDialog=function(){var a=this.toRDF(),b=d("<textarea rows='20' readonly='readonly'>").addClass("form-control").text(a),e=c.gui.dialog("Export Annotations","",["OK"],function(){this.close()});e.$content.append(d("<form>").addClass("form").append(b)),b.focus(function(){b.select().mouseup(function(){return b.unbind("mouseup"),!1})}),b.click(function(){b.focus()}).click()},c.storage.Store.prototype.showImportDialog=function(){for(var a=prompt("Paste annotations to import here: "),b=this.addFromRDF(jQuery(a).get(0)),c=0;c<b.length;c++)b[c].draw()},c.storage.Store.Selection2UUID=function(a){return"cse("+a.container+","+a.start+","+a.end+")"},c.storage.Store.UUID2Selection=function(a){var b="cse(",c=")",d=a.substring(0,b.length),e=a.substring(a.length-c.length);return d!==b||e!==c?!1:(a=a.substring(b.length,a.length-c.length),a=a.split(","),3!==a.length?!1:{container:a[0],start:a[1],end:a[2],startOffset:0,endOffset:0})},c.storage.Annotation=function(a,b,c,d,e){this.store=a;var f=e||"KAT_"+(new Date).getTime()+"_"+Math.floor(1e4*Math.random());if(this.store.find(f))throw new Error("Annotation with given uuid already exists. ");this.uuid=f,this.selection=b,this.concept=c,d="undefined"!=typeof d?d:c.getDefault(),this.values=d},c.storage.Annotation.fromRDF=function(a,b,d){var e,f=jQuery(a),g=function(a,b){var d=c.rdf.buildNameSpace(a,f.get(0));return b?d.replace(new RegExp(":","g"),"\\:"):d},h=c.rdf.findById(f,b),i=h.find("kat\\:annotates").attr("rdf:resource");if(i.substring(0,d.docURL.length+1)!=d.docURL+"#"){if(-1==i.indexOf("#"))throw new Error("Malformed RDF: Unable to parse selection URL. ");console.log("Currently loaded document does not match RDF annotation, loading it anyways ... "),e=decodeURIComponent(i.indexOf("#")+1)}else e=decodeURIComponent(i.substring(d.docURL.length+1));var j=c.storage.Store.UUID2Selection(e),k=c.rdf.findById(f,h.find("kat\\:kannspec").attr("rdf:nodeID"));if(1!==k.length)throw new Error("Malformed RDF: Unable to find KAnnSpec. ");var l=k.find("kat\\:kannspec-uri").text(),m=k.find("kat\\:kannspec-name").text();if(!m)throw new Error("Malformed RDF: Missing <kat:kannspec-name>");var n=d.collection.getKAnnSpec(m);if(!n)throw new Error("KAnnSpec '"+m+"' not loaded. ");l&&l===n.url||console.warn("Warning: KAnnSpec URL does not match. "),n.rdf_nodeid=h.find("kat\\:kannspec").attr("rdf:nodeID");var o=h.find("kat\\:concept").text();if(!o)throw new Exception("Malformed RDF: Missing <kat:concept>");var p=n.getConcept(o);if(!p)throw new Error("Concept '"+o+"' not found inside '"+m+"'");var q={};jQuery.each(p.fields,function(a,b){var d=[];b.type==c.model.Field.types.text?h.find(g(b.rdf_pred,!0)).each(function(){d.push(jQuery(this).text())}):b.type==c.model.Field.types.reference?h.find(g(b.rdf_pred,!0)).each(function(){d.push(jQuery(this).attr("rdf:nodeID"))}):b.type==c.model.Field.types.select&&h.find(g(b.rdf_pred,!0)).each(function(){for(var a=jQuery(this).attr("rdf:resource"),c=0;c<b.validation.length;c++)if(b.validation[c].rdf_obj===a||b.validation[c].value===a)return void d.push(b.validation[c]);throw new Error("Option '"+a+"' not found inside '"+m+"'")}),q[b.value]=d});var r=new c.storage.Annotation(d,j,p,q,b);return r},c.storage.Annotation.prototype.toRDF=function(a,b){var e=this,f=this.concept,g=a+"#"+encodeURIComponent(c.storage.Store.Selection2UUID(this.selection)),h=d(c.rdf.create("rdf:RDF")),i=c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",this.uuid).appendTo(h).append(c.rdf.attr(d(c.rdf.create("kat:run")),"rdf:nodeID",b),c.rdf.attr(d(c.rdf.create("kat:kannspec")),"rdf:nodeID",f.KAnnSpec.rdf_nodeid),d(c.rdf.create("kat:concept")).text(f.name),c.rdf.attr(d(c.rdf.create("kat:type")),"rdf:resource",f.rdf_type),c.rdf.attr(d(c.rdf.create("kat:annotates")),"rdf:resource",g));return jQuery.each(f.fields,function(a,b){var g=e.values[b.value],h=jQuery.isArray(g)?g:[g];jQuery.each(h,function(a,e){var g=d(c.rdf.create(c.rdf.buildNameSpace(b.rdf_pred,f.KAnnSpec.xml))).appendTo(i);b.type==c.model.Field.types.text?g.text(e):b.type==c.model.Field.types.reference?c.rdf.attr(g,"rdf:nodeID",e.uuid):b.type==c.model.Field.types.select&&c.rdf.attr(g,"rdf:resource",e.rdf_obj?e.rdf_obj:e.value)})}),h.get(0)},c.storage.Annotation.prototype.edit=function(a){c.sidebar.generateAnnotationForm(a,function(a,b,c,d){return d.values=c,d.undraw(),d.draw(),d.flash(),d},this,this.selection,this.concept)},c.storage.Annotation.prototype["delete"]=function(){this.undraw();for(var a=0;a<this.store.annotations.length;a++)if(this.store.annotations[a].uuid==this.uuid){this.store.annotations.splice(a,1);break}},c.storage.Annotation.prototype.draw=function(){var a=this;this.store.gui.getRange(this.selection).each(function(){{var b=d(this),c=b.data("KAT.Annotation.UUID")||[];c.slice()}c.push(a.uuid),b.data("KAT.Annotation.UUID",c)}),this.updateDrawing()},c.storage.Annotation.prototype.updateDrawing=function(){var a=this.store;this.store.gui.getRange(this.selection).each(function(){var b=d(this),c=b.data("KAT.Annotation.UUID")||[];if(0===c.length)-1!=this.namespaceURI.indexOf("MathML")?b.removeAttr("mathbackground").attr("mathbackground",b.data("KAT.Annotation.orgBackgroundAttr")).removeData("KAT.Annotation.orgBackgroundAttr"):b.css("background-color","").css("background-color",b.data("KAT.Annotation.orgBackgroundAttr")).removeData("KAT.Annotation.orgBackgroundAttr"),b.removeData("KAT.Annotation.hasBGCache"),b.removeAttr("title").attr("title",b.data("KAT.Annotation.orgTitleAttr")).removeData("KAT.Annotation.orgTitleAttr").removeData("KAT.Annotation.content").removeData("KAT.Annotation.hasTCache");else{var e=a.find(c[c.length-1]),f=e.concept.displayColour;-1!=this.namespaceURI.indexOf("MathML")?(b.data("KAT.Annotation.hasBGCache")!==!0&&b.data("KAT.Annotation.hasBGCache",!0).data("KAT.Annotation.orgBackgroundAttr",b.attr("mathbackground")),b.attr("mathbackground",f)):(b.data("KAT.Annotation.hasBGCache")!==!0&&b.data("KAT.Annotation.hasBGCache",!0).data("KAT.Annotation.orgBackgroundAttr",b.css("background-color")),b.css("background-color",f)),b.data("KAT.Annotation.hasTCache")!==!0&&b.data("KAT.Annotation.hasTCache",!0).data("KAT.Annotation.orgTitleAttr",b.attr("title"));var g="";d(c).each(function(b,c){g+="<p>"+a.find(c).recomputeTooltip()+"</p>"}),b.removeAttr("title").data("KAT.Annotation.content",g)}})},c.storage.Annotation.prototype.undraw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.each(function(){var b=d(this),c=d(this).data("KAT.Annotation.UUID")||[],e=c.indexOf(a.uuid);~e&&(c.splice(e,1),b.data("KAT.Annotation.UUID",c))}),this.updateDrawing()},c.storage.Annotation.prototype.recomputeTooltip=function(){var a=this,b=a.concept.display,e=function(a){return"{{= "+a+".map(function(val){return val.toString()}).join() }}"},f=[];for(var g in a.values)a.values.hasOwnProperty(g)&&(b=b.replace("{"+g+"}",e(g)).replace("{"+g.toLowerCase()+"}",e(g)),f.push(g));var h={},i=function(a){if(h.hasOwnProperty(a.uuid))return h[a.uuid];var b=h[a.uuid]={};return d.each(a.concept.fields,function(d,e){b[e.value]=e.type===c.model.Field.types.reference?a.values[e.value].map(i):e.type===c.model.Field.types.select?a.values[e.value].map(function(a){return a.name||a.value}):a.values[e.value].slice()}),b._=a,b},j=i(a),k=doT.template(b,{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"_,"+f.join(","),strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1}),l=[j].concat(f.map(function(a){return j[a]}));return k.apply(this,l)},c.storage.Annotation.prototype.flash=function(){var a=this;this.store.gui.getRange(this.selection).stop().animate({backgroundColor:"red"},1500,function(){a.updateDrawing()})},c.storage.Annotation.prototype.focus=function(){function a(a){var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return b?{r:parseInt(b[1],16),g:parseInt(b[2],16),b:parseInt(b[3],16)}:null}function b(a,b,c){return"#"+((1<<24)+(a<<16)+(b<<8)+c).toString(16).slice(1)}function e(a,b,c){return Math.round((1-c)*a+b)}function f(a){return"undefined"!=typeof d(a).attr("xml:id")&&d(a).attr("xml:id")!==!1}{var g=this.store.gui.getRange(this.selection).stop();d("<div>").addClass("focusWrapper")}g.closest("div").css({position:"relative","z-index":2}).addClass("focused"),d(".focused").find("*").not(g).each(function(){if(f(this)&&void 0!==d(this).attr("mathbackground")){var c=d(this).attr("mathbackground");d(this).attr("oldColor",c);var g=b(e(parseInt(a(c).r),parseInt(a("#000000").r),.4),e(parseInt(a(c).g),parseInt(a("#000000").g),.4),e(parseInt(a(c).b),parseInt(a("#000000").b),.4));d(this).attr("mathbackground",g)}});var h=d("<div>").addClass("focus").css({width:"100%",height:"100%",background:"rgba(0,0,0,0.4)",top:0,left:0,position:"fixed","z-index":1}).appendTo("body");d(window).scrollTop(g.scrollTop()),console.log(d(".focused").scrollTop()),c.storage.Annotation.prototype.unfocus=function(){h.remove(),d(".focused").find("*").not(g).each(function(){if(f(this)&&void 0!==d(this).attr("mathbackground")){var a=d(this).attr("oldColor");d(this).removeAttr("oldColor"),d(this).attr("mathbackground",a)}}),d(".focused").css({position:"","z-index":0}).removeClass("focused"),c.storage.Annotation.prototype.unfocus=function(){}}},c.storage.Annotation.prototype.unfocus=function(){},c.reviewStore={},c.reviewStore.Store=function(){this.annotationReviews={}},c.reviewStore.Store.prototype.clear=function(){this.annotationReviews={}},c.reviewStore.Store.prototype.toJSON=function(){return JSON.stringify(this.annotationReviews)},c.reviewStore.Store.prototype.exportReviews=function(){var a=this.toJSON(),b=d("<textarea rows='20' readonly='readonly'>").addClass("form-control").text(a),e=c.gui.dialog("Export Reviews","",["OK"],function(){this.close()});e.$content.append(d("<form>").addClass("form").append(b)),b.focus(function(){b.select().mouseup(function(){return b.unbind("mouseup"),!1})}),b.click(function(){b.focus()}).click()},c.reviewStore.Store.prototype.importReviews=function(){var a=prompt("Paste reviews to import here: ");this.annotationReviews=JSON.parse(a)},c.module={info:{identifier:"KAT.module",title:"KAT module",author:"The KWARC group",description:"A module for KAT",url:"http://kwarc.github.io/KAT",version:"2.0",dependencies:[],externals:{js:[],css:[]},async:!1,hasCleanNamespace:!1},init:function(a,b,d,e){console.log("Given as argument: "),console.log(e);var f;b instanceof c.model.KAnnSpecCollection?f=b:(f=new c.model.KAnnSpecCollection,f.addNewKAnnSpec(b[0],b[1])),this.gui=new c.gui(a.element,f),this.store=new c.storage.Store(this.gui,d),this.reviewStore=new c.reviewStore.Store,c.sidebar.init(this.store,this.reviewStore),f.init(),f.assignDisplayColour()},hoverText:function(a){var b=a.data("KAT.Annotation.content");return b?d("<div>").html(b):void 0},contextMenuEntries:function(a){var b=this,e="Delete Annotation",f="Highlight Annotation",g="Edit Annotation",h="Import Annotations",i="Export Annotations",j={},k=function(){j[h]=b.store.showImportDialog.bind(b.store),j[i]=b.store.showExportDialog.bind(b.store)};switch(c.sidebar.annotationMode){case"Annotation":var l;try{l=this.gui.getSelection()}catch(m){}if(!l||l.isEmpty){k();var n=this.store.findfromElement(a);0!==n.length&&(j={},j[e]={},j[f]={},j[g]={},d.each(n,function(a,c){j[e][c.uuid]=function(){c["delete"]()},j[f][c.uuid]=function(){c.flash()},j[g][c.uuid]=function(){c.edit(b)}}))}else(l.start!=l.end||l.startOffset!=l.endOffset)&&d.each(this.gui.collection.findConcepts(),function(a,d){j[d.getFullName()]=function(){c.sidebar.generateAnnotationForm(b,b.store.addNew.bind(b.store),void 0,l,d)}});break;case"Review":k();break;default:k()}return j}},JOBAD.modules.register(c.module),function(){"use strict";function a(b,c,d){return("string"==typeof c?c:c.toString()).replace(b.define||f,function(a,c,e,f){return 0===c.indexOf("def.")&&(c=c.substring(4)),c in d||(":"===e?(b.defineParams&&f.replace(b.defineParams,function(a,b,e){d[c]={arg:b,text:e}}),c in d||(d[c]=f)):new Function("def","def['"+c+"']="+f)(d)),""}).replace(b.use||f,function(c,e){b.useParams&&(e=e.replace(b.useParams,function(a,b,c,e){if(d[c]&&d[c].arg&&e){var f=(c+":"+e).replace(/'|\\/g,"_");return d.__exp=d.__exp||{},d.__exp[f]=d[c].text.replace(new RegExp("(^|[^\\w$])"+d[c].arg+"([^\\w$])","g"),"$1"+e+"$2"),b+"def.__exp['"+f+"']"}}));var f=new Function("def","return "+e)(d);return f?a(b,f,d):f})}function b(a){return a.replace(/\\('|\\)/g,"$1").replace(/[\r\t\n]/g," ")}var c,d={version:"1.0.3",templateSettings:{evaluate:/\{\{([\s\S]+?(\}?)+)\}\}/g,interpolate:/\{\{=([\s\S]+?)\}\}/g,encode:/\{\{!([\s\S]+?)\}\}/g,use:/\{\{#([\s\S]+?)\}\}/g,useParams:/(^|[^\w$])def(?:\.|\[[\'\"])([\w$\.]+)(?:[\'\"]\])?\s*\:\s*([\w$\.]+|\"[^\"]+\"|\'[^\']+\'|\{[^\}]+\})/g,define:/\{\{##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\}\}/g,defineParams:/^\s*([\w$]+):([\s\S]+)/,conditional:/\{\{\?(\?)?\s*([\s\S]*?)\s*\}\}/g,iterate:/\{\{~\s*(?:\}\}|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\}\})/g,varname:"it",strip:!0,append:!0,selfcontained:!1,doNotSkipEncoded:!1},template:void 0,compile:void 0};d.encodeHTMLSource=function(a){var b={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},c=a?/[&<>"'\/]/g:/&(?!#?\w+;)|<|>|"|'|\//g;return function(a){return a?a.toString().replace(c,function(a){return b[a]||a}):""}},c=function(){return this||(0,eval)("this")}(),"undefined"!=typeof module&&module.exports?module.exports=d:"function"==typeof define&&define.amd?define(function(){return d}):c.doT=d;var e={append:{start:"'+(",end:")+'",startencode:"'+encodeHTML("},split:{start:"';out+=(",end:");out+='",startencode:"';out+=encodeHTML("}},f=/$^/;d.template=function(g,h,i){h=h||d.templateSettings;var j,k,l=h.append?e.append:e.split,m=0,n=h.use||h.define?a(h,g,i||{}):g;n=("var out='"+(h.strip?n.replace(/(^|\r|\n)\t* +| +\t*(\r|\n|$)/g," ").replace(/\r|\n|\t|\/\*[\s\S]*?\*\//g,""):n).replace(/'|\\/g,"\\$&").replace(h.interpolate||f,function(a,c){return l.start+b(c)+l.end}).replace(h.encode||f,function(a,c){return j=!0,l.startencode+b(c)+l.end}).replace(h.conditional||f,function(a,c,d){return c?d?"';}else if("+b(d)+"){out+='":"';}else{out+='":d?"';if("+b(d)+"){out+='":"';}out+='"}).replace(h.iterate||f,function(a,c,d,e){return c?(m+=1,k=e||"i"+m,c=b(c),"';var arr"+m+"="+c+";if(arr"+m+"){var "+d+","+k+"=-1,l"+m+"=arr"+m+".length-1;while("+k+"<l"+m+"){"+d+"=arr"+m+"["+k+"+=1];out+='"):"';} } out+='"}).replace(h.evaluate||f,function(a,c){return"';"+b(c)+"out+='"})+"';return out;").replace(/\n/g,"\\n").replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/(\s|;|\}|^|\{)out\+='';/g,"$1").replace(/\+''/g,""),j&&(h.selfcontained||!c||c._encodeHTML||(c._encodeHTML=d.encodeHTMLSource(h.doNotSkipEncoded)),n="var encodeHTML = typeof _encodeHTML !== 'undefined' ? _encodeHTML : ("+d.encodeHTMLSource.toString()+"("+(h.doNotSkipEncoded||"")+"));"+n);try{return new Function(h.varname,n)}catch(o){throw"undefined"!=typeof console&&console.log("Could not create a template function: "+n),o}},d.compile=function(a,b){return d.template(a,null,b)}}()}({},function(){return this}());
//# sourceMappingURL=KAT.min.js.map