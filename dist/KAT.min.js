/**
Copyright (c) 2014-15 by the KWARC Group (http://kwarc.info)

KAT is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

KAT is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with KAT.  If not, see <http://www.gnu.org/licenses/>
*/

<<<<<<< HEAD
var KAT={};KAT.rdf={},KAT.rdf.create=function(a){return document.createElementNS("http://www.w3.org/1999/02/22-rdf-syntax-ns#",a)},KAT.rdf.attr=function(a,b,c){return $(a).get(0).setAttribute(b,c),a},KAT.rdf.resolveWithNameSpace=function(a,b){var c=a.split(":");if(2==c.length){var d=$(b).find("annotation").eq(0);return d.attr("xmlns:"+c[0])+c[1]}return a},KAT.rdf.buildNameSpace=function(a,b){for(var c,d,e,f=$(b).find("annotation").get(0),g=0;g<f.attributes.length;g++)if(c=f.attributes[g],"xmlns"==c.name.substring(0,"xmlns".length)&&(d=c.name.split(":")[1]||"",a.startsWith(c.value)))return e=a.substring(c.value.length),""!==d?d+":"+e:e;return a},KAT.model={},KAT.model.nameRegExS="(?:\\w|\\d|\\-|\\_|\\+)+",KAT.model.nameRegEx=new RegExp("^"+KAT.model.nameRegExS+"$"),KAT.model.nameRegEx2=new RegExp("^("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")$"),KAT.model.nameRegEx3=new RegExp("^("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")$"),KAT.model.nameNormaliser=function(a){return a},KAT.model.ParsingError=function(a,b){var c=Error.apply(this,[a]);return c.name=this.name="KAT.model.ParsingError",c.node=this.node=b,b instanceof jQuery&&(c.node=this.node=b.toArray()),this.message=c.message,Object.defineProperty(this,"stack",{get:function(){return c.stack}}),this},function(){var a=function(){};a.prototype=Error.prototype,KAT.model.ParsingError.prototype=new a}(),KAT.model.KAnnSpecCollection=function(){this.KAnnSpecs=[]},KAT.model.KAnnSpecCollection.prototype.addKAnnSpec=function(a){return this.getKAnnSpec(a.name)?!1:(this.KAnnSpecs.push(a),a)},KAT.model.KAnnSpecCollection.prototype.addNewKAnnSpec=function(a){return this.addKAnnSpec(new KAT.model.KAnnSpec(a,this))},KAT.model.KAnnSpecCollection.prototype.init=function(){return $.each(this.KAnnSpecs,function(a,b){$.each(b.concepts,function(a,b){$.each(b.fields,function(){if(this.type==KAT.model.Field.types.reference)for(var a=0;a<this.validation.length;a++){var b=this.validation[a];b instanceof KAT.model.Concept&&(b=b.getFullName());var c=this.concept.KAnnSpec.getConcept(b);if(c||(c=this.concept.KAnnSpec.collection.getConcept(b)),!c)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Concept not found: '"+b+"'). ",this.xml);this.validation[a]=c}}.bind(b))}.bind(b))}),this},KAT.model.KAnnSpecCollection.prototype.getKAnnSpec=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.KAnnSpecs.length;b++)if(this.KAnnSpecs[b].name==a)return this.KAnnSpecs[b];return!1},KAT.model.KAnnSpecCollection.prototype.getConcept=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx2.test(a))return!1;a=a.match(KAT.model.nameRegEx2);var b=this.getKAnnSpec(a[1]);return b?b.getConcept(a[2]):!1},KAT.model.KAnnSpecCollection.prototype.findConcepts=function(){for(var a=[],b=0;b<this.KAnnSpecs.length;b++)for(var c=0;c<this.KAnnSpecs[b].concepts.length;c++)a.push(this.KAnnSpecs[b].concepts[c]);return a},KAT.model.KAnnSpecCollection.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx3.test(a))return!1;a=a.match(KAT.model.nameRegEx3);var b=this.getKAnnSpec(a[1]);if(!b)return!1;var c=b.getConcept(a[2]);return c?c.getField(a[3]):!1},KAT.model.KAnnSpec=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Unable to parse XML). ",this.xml)}if(1!=this.xml.children().length||!this.xml.children().eq(0).is("annotation"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Expected exactly one top-level <annotation>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.children().eq(0).attr("name")),this.rdf_nodeid="KAT_"+(new Date).getTime()+"_"+this.name,!this.name||!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Unable to create KAnnSpec ('"+this.name+"' is not a valid name). ",this.xml);var d=this.xml.children().eq(0);if(d.children().length<=1||!d.children().eq(0).is("documentation"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected exactly one <documentation>). ",d);this.collection=b,this.documentation=d.children().eq(0).text().trim(),this.concepts=[],d.children().slice(1).each(function(a,b){if(b=$(b),!b.is("concept"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected child tag <concept>). ",b);this.concepts.push(new KAT.model.Concept(b,this))}.bind(this))},KAT.model.KAnnSpec.prototype.getFullName=function(){return this.name},KAT.model.KAnnSpec.prototype.getConcept=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.concepts.length;b++)if(this.concepts[b].name==a)return this.concepts[b];return!1},KAT.model.KAnnSpec.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx2.test(a))return!1;a=a.match(KAT.model.nameRegEx2);var b=this.getConcept(a[1]);return b?b.getField(a[2]):!1},KAT.model.Concept=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML (Unable to parse XML). ",this.xml)}if(this.KAnnSpec=b,"string"!=typeof this.xml.attr("name"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing name attribute for <concept>). ",this.xml);if("string"!=typeof this.xml.attr("rdftype"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing rdftype attribute for <concept>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.attr("name")),!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.KAnnSpec.getConcept(this.name))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML (Concept '"+this.getFullName()+"' already exists). ",this.xml);if(this.rdf_type=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdftype"),this.KAnnSpec.xml),1!=this.xml.length||!this.xml.is("concept"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected exactly one <concept> tag). ",this.xml);this.documentation="",this.fields=[],this.display="";var d=this.xml.children(),e=0;if(d.length<2)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <field>, <display> and <rdf:rdf>). ",d);d.eq(e).is("documentation")&&(this.documentation=d.eq(e).text().trim(),e++);for(var f=!1;d.eq(e).is("field")&&e<d.length;)f=!0,this.fields.push(new KAT.model.Field(d.eq(e),this)),e++;if(!f)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing at least one declared <field>). ",d);if(!d.eq(e).is("display"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing required <display>). ",d);var g=d.eq(e);if(1!=g.children().length||!g.children().eq(0).is("template"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing <template>). ",g);if(this.display=g.children().html().trim(),e++,e<d.length){if("rdf:RDF"!=d.eq(e).prop("tagName"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected <rdf:rdf> in final position. ). ",d);this.rdf=d.eq(e).html().trim(),e++}if(e!=d.length)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <fields>, <display> and <rdf:RDF>). ",d)},KAT.model.Concept.prototype.getDefault=function(){var a={};return $.each(this.fields,function(b){b.type==KAT.model.Field.types.text?a[b.value]=b["default"]:b.type==KAT.model.Field.types.select?a[b.value]=""===b["default"]?b.validation[0]:b["default"]:b.type==KAT.model.Field.types.reference&&(a[b.value]="")}),a},KAT.model.Concept.prototype.getFullName=function(){return this.KAnnSpec.getFullName()+"."+this.name},KAT.model.Concept.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.fields.length;b++)if(this.fields[b].name==a)return this.fields[b];return!1},KAT.model.Field=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.Field("KAT.model.Field: Invalid XML (Unable to parse XML). ",this.xml)}if(this.concept=b,"string"!=typeof this.xml.attr("name"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML (Missing name attribute for <field>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.attr("name")),!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.concept.getField(this.name))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML (Field '"+this.getFullName()+"' already exists). ",this.xml);if("string"!=typeof this.xml.attr("type"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing type attribute for <field>). ",this.xml);if("string"!=typeof this.xml.attr("rdfpred"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing rdfpred attribute for <field>). ",this.xml);if(!KAT.model.Field.types.hasOwnProperty(this.xml.attr("type")))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unknown <field> type). ",this.xml);this.type=KAT.model.Field.types[this.xml.attr("type")],this.rdf_pred=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdfpred"),this.concept.KAnnSpec.xml),this.minimum=1,this.maximum=1,this.value="",this["default"]="",this.documentation="",this.validation=void 0;var d=!1,e=!1,f=!1,g=!1,h=!1;if(this.validation=this.type==KAT.model.Field.types.text?new RegExp(".*"):[],this.xml.children().each(function(a,b){if(b=$(b),b.is("value")){if(d)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <value> tag). ",b);d=!0,this.value=b.text()}else if(b.is("number")){if(g)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <number> tag). ",b);g=!0;try{this.minimum=parseInt(b.attr("atleast"))}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atleast property must be a number). ",b)}try{this.maximum=parseInt(b.attr("atmost"))}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atmost property must be a number). ",b)}}else if(b.is("documentation")){if(h)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <documentation> tag). ",b);h=!0,this.documentation=b.text().trim()}else if(b.is("default")&&this.type==KAT.model.Field.types.text){if(e)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <default> tag). ",b);e=!0,this["default"]=b.text()}else if(b.is("validation")&&this.type==KAT.model.Field.types.text){if(f)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <validation> tag). ",b);f=!0;try{this.validation=new RegExp(b.text())}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unregonised regular expression). ",b)}}else if(b.is("referencedType")&&this.type==KAT.model.Field.types.reference)this.validation.push(b.text());else if(b.is("option")&&this.type==KAT.model.Field.types.select)this.validation.push(new KAT.model.Option(b,this));else{if(!b.is("defaultoption")||this.type!=KAT.model.Field.types.select)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unexpected tag '"+b.prop("tagName")+"'). ",b);this.validation.push(new KAT.model.Option(b,this))}}.bind(this)),d||(this.value=this.name),this.type==KAT.model.Field.types.select&&0===this.validation.length)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (KAT.model.Field.types.select must have a non-empty list of options. ). ",c);for(var i=0;i<this.concept.fields.length;i++)if(this.concept.fields[i].value==this.value)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Value '"+this.value+"' already used by field '"+this.concept.fields[i].getFullName()+"'). ",this.xml)},KAT.model.Field.prototype.getFullName=function(){return this.concept.getFullName()+"."+this.name},KAT.model.Field.types={reference:"reference",select:"select",text:"text"},KAT.model.Option=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Unable to parse XML). ",this.xml)}if(this.field=b,1!=this.xml.find("value").length)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Expected exactly one <value>. )",this.xml);this.value=this.xml.find("value").text();for(var d=0;d<this.field.validation.length;d++)if(this.field.validation[d].value==this.value)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Value '"+this.value+"' already used). ",this.xml);if(this.xml.is("defaultoption")){if(""!==this.field["default"])throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Default already exists)",this.xml);this.field["default"]=this.value}if(this.rdf_obj=!1,"string"==typeof this.xml.attr("rdfobj")&&(this.rdf_obj=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdfobj"),this.field.concept.KAnnSpec.xml)),this.documentation=this.xml.find("documentation").text(),this.xml.children().length>2)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Too many children. )",this.xml)},KAT.gui=function(a,b){b.init(),this.collection=b,this.element=a},KAT.gui.prototype.getSelection=function(){var a=window.getSelection().getRangeAt(0),b=this.element,c=KAT.gui.getXPath(b,a.commonAncestorContainer),d=KAT.gui.getXPath(b,a.startContainer.parentElement),e=KAT.gui.getXPath(b,a.endContainer.parentElement);return{container:c,start:d,startOffset:a.startOffset,end:e,endOffset:a.endOffset}},KAT.gui.getXPath=function(a,b){for(var c=$(b).get(0),d=$(a).get(0),e=[];c&&c!==d;c=c.parentNode){for(var f=0,g=c.previousSibling;g;g=g.previousSibling)g.nodeType!=Node.DOCUMENT_TYPE_NODE&&g.nodeName==c.nodeName&&++f;var h=c.nodeName.toLowerCase(),i=f?"["+(f+1)+"]":"";e.splice(0,0,h+i)}return e.length?"/"+e.join("/"):null},KAT.gui.resolveXPath=function(a,b){for(var c,d,e,f,g=$(a).get(0),h=b.split("/").splice(1),i=function(a){return(a.tagName||a.nodeName).toLowerCase()==d.toLowerCase()},j=0;j<h.length;j++)if(c=h[j],d=c.split("[")[0],e=parseInt((c.split("[")[1]||"1]").split("]")[0])-1,f=g,g=Array.prototype.filter.call(g.children,i)[e],void 0===g)return void console.log("undefined",f,c,d,e);return g},KAT.gui.prototype.getRange=function(a){var b=$(KAT.gui.resolveXPath(this.element,a.container)),c=b.find("*").andSelf(),d=c.index(KAT.gui.resolveXPath(this.element,a.start)),e=$(KAT.gui.resolveXPath(this.element,a.end)),f=c.index(e);return c=c.slice(d,f),c.filter(function(a,b){var d=$(b).children();return d.length==c.filter(d).length}).add(e.find("*").andSelf())},KAT.gui.dialog=function(a,b,c,d){var e={},f=$([]);$.each(c,function(a){f=f.add($("<button class='btn btn-"+(0===a?"primary":"default")+"'>").text(c[a]).click(function(){d.call(e,c[a],a)}))}),f=$(f.get().reverse());var g=$('<h4 class="modal-title"></h4>').text(a),h=$("<p>").text(b),i=$('<div class="modal hide large">').append($('<div class="modal-dialog">').append($('<div class="modal-content">').append($('<div class="modal-header>').append($('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>').click(function(){return d.call(e,"",-1),!1}),g),$('<div class="modal-body">').append(h),$('<div class="modal-footer">').append(f))));return i.appendTo($("<div>").BS().appendTo("body")).modal().on("hidden",function(){JOBAD.UI.BSStyle()}),JOBAD.UI.BSStyle(),e={$dialog:i,$title:g,$content:h,$buttons:f,close:function(){i.one("hidden.bs.modal",function(){i.remove()}).modal("hide")}}},KAT.gui.selectDialog=function(a,b,c,d,e){var f,g=0;if("function"==typeof d&&"undefined"==typeof e&&(e=d,d=function(){return""}),Array.isArray(d)){var h=d;d=function(a,b){return h[b]}}$self=KAT.gui.dialog(a,b,["OK","Cancel"],function(a,b){$self.close(),0===b?e.call($self,c[g],g):e.call($self,"",-1)});var i=$("<span>"),j=$("<span style='margin-left: 10px; '>"),k=$('<ul class="dropdown-menu" role="menu">'),l=$("<div class='dropdown'>").append($('<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">').append(i,'<span class="caret"></span>'),k,j);return $.each(c,function(a,b){k.append($('<li role="presentation">').append($('<a role="menuitem" tabindex="-1" href="#">').text(b).click(function(){g=a,f()})))}),$self.$content.empty().append($("<h3>").text(b),l),f=function(){i.text(c[g]),j.text(d(c[g],g))},f(),$self},KAT.sidebar={},KAT.sidebar.init=function(){var a=-230,b=jQuery(window).height(),c=jQuery("<div>").addClass("collapsible").append($("<ul>").addClass("KATMenuItems")).css({position:"fixed",right:a,height:b-10}).prependTo("body"),d=$("<button>").text("«").addClass("collapseToggle").css({height:b-10}).click(KAT.sidebar.toggleAnnotationMode).prependTo(c);jQuery("body").css({width:jQuery(window).width()-50}),jQuery(window).resize(function(){b=jQuery(window).height(),c.css({position:"fixed",right:a,height:b-10}),d.css({height:b-10}),jQuery("body").css({width:jQuery(window).width()-50})})},KAT.sidebar.toggleAnnotationMode=function(){var a=-230;KAT.sidebar.annotationMode?(KAT.sidebar.annotationMode=!1,jQuery(".collapseToggle").text("«").parent().animate({right:a},2e3),jQuery("body").css({width:jQuery(window).width()-50})):(KAT.sidebar.annotationMode=!0,jQuery(".collapseToggle").text("»").parent().animate({right:"0"},2e3),jQuery("body").css({width:jQuery(window).width()-260}))},KAT.sidebar.genNewAnnotationForm=function(a,b,c,d){KAT.sidebar.annotationMode||KAT.sidebar.toggleAnnotationMode();var e=$("<li>").addClass("currentForm").append("<b> Enter Annotation Details</b><br>").appendTo(".KATMenuItems"),f=jQuery.map(d.fields,function(b){var c,d=b.validation,f=b.value;if(e.append(jQuery("<span>").text(f)),b.type===KAT.model.Field.types.text&&(c=jQuery("<input type='text'>").appendTo(e)),b.type===KAT.model.Field.types.select&&(c=jQuery("<select>").appendTo(e),$.each(d,function(a,b){jQuery("<option>").text(b.value).val(a).appendTo(c)})),b.type===KAT.model.Field.types.reference){c=jQuery("<select>").appendTo(e);var g=a.store.filterByConcept.apply(a.store,d);jQuery.each(g,function(a,b){$("<option>").text(b.uuid).val(b.uuid).appendTo(c)})}return c});$("<input type='button'>").val("Add").appendTo(e).click(function(){var g={};$.each(d.fields,function(b,c){var d=f[b];g[c.value]=c.type==KAT.model.Field.types.reference?[a.store.find(d.val())]:c.type==KAT.model.Field.types.select?[c.validation[d.val()]]:[d.val()]}),e.remove(),KAT.sidebar.annotationMode&&$(".KATMenuItems").children().length<1&&KAT.sidebar.toggleAnnotationMode();var h=b(c,d,g);h.draw()}),$("<input type='button'>").val("Cancel").appendTo(e).click(function(){e.remove(),KAT.sidebar.annotationMode&&$(".KATMenuItems").children().length<1&&KAT.sidebar.toggleAnnotationMode()})},KAT.sidebar.annotationMode=!1,KAT.storage={},KAT.storage.Store=function(a){this.collection=a.collection,this.gui=a,this.annotations=[]},KAT.storage.Store.prototype.addNew=function(a,b,c){var d=new KAT.storage.Annotation(this,a,b,c);return this.annotations.push(d),d},KAT.storage.Store.prototype.addFromJSON=function(a){var b=new KAT.storage.Annotation(this,KAT.storage.Store.UUID2Selection(a.uuid),this.collection.getConcept(a.concept));return b.values=a.values,this.annotations.push(b),b},KAT.storage.Store.prototype.filterByConcept=function(){var a=[],b=jQuery.makeArray(arguments),c=0===b.length;return jQuery.each(this.annotations,function(d,e){(c||-1!=b.indexOf(e.concept.name))&&a.push(e)}),a},KAT.storage.Store.prototype.find=function(a){for(var b=0;b<this.annotations.length;b++)if(this.annotations[b].uuid==a)return this.annotations[b];return void 0},KAT.storage.Store.prototype.findfromElement=function(a){for(var b=$(a).parentsUntil(this.element).andSelf().add(this.element),c=[],d=[],e=b.length-1;e>=0;e--)for(var f=b.eq(e).data("KAT.Annotation.UUID")||[],g=0;g<f.length;g++)-1==c.indexOf(f[g])&&(c.push(f[g]),d.push(this.find(f[g])));return d},KAT.storage.Store.prototype.sanityCheck=function(){return!0},KAT.storage.Store.prototype.toRDF=function(a){var b=$(KAT.rdf.create("rdf:RDF")).attr("xmlns:kat","https://github.com/KWARC/KAT/").attr("xmlns:rdf","http://www.w3.org/1999/02/22-rdf-syntax-ns#"),c="kat_run";b.append($(KAT.rdf.create("rdf:Description")).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",c)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",c).append(KAT.rdf.attr($(KAT.rdf.create("rdf:type")),"rdf:resource","kat:run"),KAT.rdf.attr($("<kat:date />").text((new Date).toISOString()),"rdf:datatype","xs:dateTime"),$("<kat:tool>").text("KAT"),$("<kat:runid>").text("0")));var d={};return jQuery.each(this.annotations,function(e,f){var g=f.concept.KAnnSpec;d[g.rdf_nodeid]||(d[g.rdf_nodeid]=!0,g.xml.find("annotation").each(function(){$.each(this.attributes,function(a,c){var d=c.name,e=c.value;d.startsWith("xmlns:")&&b.attr(d,e)})}),b.append($(KAT.rdf.create("rdf:Description")).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",g.rdf_nodeid)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",g.rdf_nodeid).append(KAT.rdf.attr($("<rdf:type>"),"rdf:resource","kat:kannspec"),$("<kat:kannspec-name>").text(g.name),$("<kat:kannspec-URI>").text("about:blank")))),b.append($(f.toRDF(a,c)).children())}),b.get(0).outerHTML},KAT.storage.Store.Selection2UUID=function(a){return"cse("+a.container+","+a.start+","+a.end+")"},KAT.storage.Store.UUID2Selection=function(a){var b="cse(",c=")",d=a.substring(0,b.length),e=a.substring(a.length-c.length);return d!==b||e!==c?!1:(a=a.substring(b.length,a.length-c.length),a=a.split(","),3!==a.length?!1:{container:a[0],start:a[1],end:a[2],startOffset:0,endOffset:0})},KAT.storage.Annotation=function(a,b,c,d){this.store=a;var e=KAT.storage.Store.Selection2UUID(b);if(this.store.find(e))throw new Error("Annotation with given uuid already exists. ");this.uuid=e,this.selection=b,this.concept=c,this.rdf_id="KAT_"+(new Date).getTime()+"_"+Math.floor(1e4*Math.random()),d="undefined"!=typeof d?d:c.getDefault(),this.values=d},KAT.storage.Annotation.prototype["delete"]=function(){this.undraw();for(var a=0;a<this.store.annotations.length;a++)if(this.store.annotations[a].uuid==this.uuid){this.store.annotations.splice(a,1);break}this.store.sanityCheck()},KAT.storage.Annotation.prototype.draw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.addClass("KAT-selection").each(function(){var b=$(this),c=b.data("KAT.Annotation.UUID")||[];c.push(a.uuid),b.data("KAT.Annotation.UUID",c)})},KAT.storage.Annotation.prototype.flash=function(){this.store.gui.getRange(this.selection).stop().animate({backgroundColor:"red"},1500,function(){$(this).css("background-color","")})},KAT.storage.Annotation.prototype.edit=function(){alert("Unimplemented!")},KAT.storage.Annotation.prototype.undraw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.removeClass("KAT-selection").each(function(){var b=$(this),c=$(this).data("KAT.Annotation.UUID")||[],d=c.indexOf(a.uuid);~d&&(c.splice(d,1),b.data("KAT.Annotation.UUID",c))})},KAT.storage.Annotation.prototype.toJSON=function(){return{uuid:this.uuid,concept:this.concept.getFullName(),values:this.values}},KAT.storage.Annotation.prototype.toRDF=function(a,b){var c=this,d=this.concept,e=$(KAT.rdf.create("rdf:RDF")),f=(KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:about",a+"#"+encodeURIComponent(KAT.storage.Store.Selection2UUID(this.selection))).appendTo(e).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",this.rdf_id)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",this.rdf_id).appendTo(e).append(KAT.rdf.attr($(KAT.rdf.create("kat:run")),"rdf:nodeID",b),KAT.rdf.attr($(KAT.rdf.create("kat:kannspec")),"rdf:nodeID",d.KAnnSpec.rdf_nodeid),$(KAT.rdf.create("kat:concept")).text(d.name)));return jQuery.each(d.fields,function(a,b){var e=c.values[b.value],g=jQuery.isArray(e)?e:[e];jQuery.each(g,function(a,c){b.type==KAT.model.Field.types.text?$(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).text(c).appendTo(f):b.type==KAT.model.Field.types.reference?(KAT.rdf.attr($(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).appendTo(f),"rdf:resource",c.rdf_id),console.log(c)):b.type==KAT.model.Field.types.select&&(console.log(c),KAT.rdf.attr($(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).appendTo(f),"rdf:resource",c.rdf_obj?c.rdf_obj:c.value))})}),e.get(0)},KAT.module={info:{identifier:"KAT.module",title:"KAT module",author:"The KWARC group",description:"A module for KAT",url:"http://kwarc.github.io/KAT",version:"2.0",dependencies:[],externals:{js:[],css:[]},async:!1,hasCleanNamespace:!1},init:function(a,b){this.store=b,this.gui=this.store.gui},contextMenuEntries:function(a){var b,c=this,d="Delete Annotation",e="Highlight Annotation",f="Edit Annotation",g={};try{b=this.gui.getSelection()}catch(h){}b&&(b.start!=b.end||b.startOffset!=b.endOffset)&&(g={},$.each(this.gui.collection.findConcepts(),function(a,d){g[d.getFullName()]=function(){KAT.sidebar.genNewAnnotationForm(c,c.store.addNew.bind(c.store),b,d)}}));var i=this.store.findfromElement(a);return 0!==i.length?$.each(i,function(a,b){g[d][b.uuid]=function(){b["delete"]()},g[e][b.uuid]=function(){b.flash()},g[f][b.uuid]=function(){b.edit()}}):(g[d]=!1,g[e]=!1,g[f]=!1),g.Storage={Import:function(){var a=prompt("Paste the annotations below: ");if(a){a=JSON.parse(a);for(var b=0;b<a.length;b++)a[b]=c.store.addFromJSON(a[b]),a[b].draw()}},Export:function(){var a=c.store.toRDF();console.log(a),prompt("Press CTRL+C to export annotations: ",a)}},g}},JOBAD.modules.register(KAT.module);
=======
var KAT={};KAT.rdf={},KAT.rdf.create=function(a){return document.createElementNS("http://www.w3.org/1999/02/22-rdf-syntax-ns#",a)},KAT.rdf.attr=function(a,b,c){return $(a).get(0).setAttribute(b,c),a},KAT.rdf.resolveWithNameSpace=function(a,b){var c=a.split(":");if(2==c.length){var d=$(b).find("annotation").eq(0);return d.attr("xmlns:"+c[0])+c[1]}return a},KAT.rdf.buildNameSpace=function(a,b){for(var c,d,e,f=$(b).find("annotation").get(0),g=0;g<f.attributes.length;g++)if(c=f.attributes[g],"xmlns"==c.name.substring(0,"xmlns".length)&&(d=c.name.split(":")[1]||"",a.startsWith(c.value)))return e=a.substring(c.value.length),""!==d?d+":"+e:e;return a},KAT.model={},KAT.model.nameRegExS="(?:\\w|\\d|\\-|\\_|\\+)+",KAT.model.nameRegEx=new RegExp("^"+KAT.model.nameRegExS+"$"),KAT.model.nameRegEx2=new RegExp("^("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")$"),KAT.model.nameRegEx3=new RegExp("^("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")\\.("+KAT.model.nameRegExS+")$"),KAT.model.nameNormaliser=function(a){return a},KAT.model.ParsingError=function(a,b){var c=Error.apply(this,[a]);return c.name=this.name="KAT.model.ParsingError",c.node=this.node=b,b instanceof jQuery&&(c.node=this.node=b.toArray()),this.message=c.message,Object.defineProperty(this,"stack",{get:function(){return c.stack}}),this},function(){var a=function(){};a.prototype=Error.prototype,KAT.model.ParsingError.prototype=new a}(),KAT.model.KAnnSpecCollection=function(){this.KAnnSpecs=[]},KAT.model.KAnnSpecCollection.prototype.addKAnnSpec=function(a){return this.getKAnnSpec(a.name)?!1:(this.KAnnSpecs.push(a),a)},KAT.model.KAnnSpecCollection.prototype.addNewKAnnSpec=function(a){return this.addKAnnSpec(new KAT.model.KAnnSpec(a,this))},KAT.model.KAnnSpecCollection.prototype.init=function(){return $.each(this.KAnnSpecs,function(a,b){$.each(b.concepts,function(a,b){$.each(b.fields,function(){if(this.type==KAT.model.Field.types.reference)for(var a=0;a<this.validation.length;a++){var b=this.validation[a];b instanceof KAT.model.Concept&&(b=b.getFullName());var c=this.concept.KAnnSpec.getConcept(b);if(c||(c=this.concept.KAnnSpec.collection.getConcept(b)),!c)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Concept not found: '"+b+"'). ",this.xml);this.validation[a]=c}}.bind(b))}.bind(b))}),this},KAT.model.KAnnSpecCollection.prototype.getKAnnSpec=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.KAnnSpecs.length;b++)if(this.KAnnSpecs[b].name==a)return this.KAnnSpecs[b];return!1},KAT.model.KAnnSpecCollection.prototype.getConcept=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx2.test(a))return!1;a=a.match(KAT.model.nameRegEx2);var b=this.getKAnnSpec(a[1]);return b?b.getConcept(a[2]):!1},KAT.model.KAnnSpecCollection.prototype.findConcepts=function(){for(var a=[],b=0;b<this.KAnnSpecs.length;b++)for(var c=0;c<this.KAnnSpecs[b].concepts.length;c++)a.push(this.KAnnSpecs[b].concepts[c]);return a},KAT.model.KAnnSpecCollection.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx3.test(a))return!1;a=a.match(KAT.model.nameRegEx3);var b=this.getKAnnSpec(a[1]);if(!b)return!1;var c=b.getConcept(a[2]);return c?c.getField(a[3]):!1},KAT.model.KAnnSpec=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Unable to parse XML). ",this.xml)}if(1!=this.xml.children().length||!this.xml.children().eq(0).is("annotation"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Expected exactly one top-level <annotation>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.children().eq(0).attr("name")),this.rdf_nodeid="KAT_"+(new Date).getTime()+"_"+this.name,!this.name||!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Unable to create KAnnSpec ('"+this.name+"' is not a valid name). ",this.xml);var d=this.xml.children().eq(0);if(d.children().length<=1||!d.children().eq(0).is("documentation"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected exactly one <documentation>). ",d);this.collection=b,this.documentation=d.children().eq(0).text().trim(),this.concepts=[],d.children().slice(1).each(function(a,b){if(b=$(b),!b.is("concept"))throw new KAT.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected child tag <concept>). ",b);this.concepts.push(new KAT.model.Concept(b,this))}.bind(this))},KAT.model.KAnnSpec.prototype.getFullName=function(){return this.name},KAT.model.KAnnSpec.prototype.getConcept=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.concepts.length;b++)if(this.concepts[b].name==a)return this.concepts[b];return!1},KAT.model.KAnnSpec.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx2.test(a))return!1;a=a.match(KAT.model.nameRegEx2);var b=this.getConcept(a[1]);return b?b.getField(a[2]):!1},KAT.model.Concept=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML (Unable to parse XML). ",this.xml)}if(this.KAnnSpec=b,"string"!=typeof this.xml.attr("name"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing name attribute for <concept>). ",this.xml);if("string"!=typeof this.xml.attr("rdftype"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing rdftype attribute for <concept>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.attr("name")),!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.KAnnSpec.getConcept(this.name))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML (Concept '"+this.getFullName()+"' already exists). ",this.xml);if(this.rdf_type=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdftype"),this.KAnnSpec.xml),1!=this.xml.length||!this.xml.is("concept"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected exactly one <concept> tag). ",this.xml);this.documentation="",this.fields=[],this.display="";var d=this.xml.children(),e=0;if(d.length<2)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <field>, <display> and <rdf:rdf>). ",d);d.eq(e).is("documentation")&&(this.documentation=d.eq(e).text().trim(),e++);for(var f=!1;d.eq(e).is("field")&&e<d.length;)f=!0,this.fields.push(new KAT.model.Field(d.eq(e),this)),e++;if(!f)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing at least one declared <field>). ",d);if(!d.eq(e).is("display"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing required <display>). ",d);var g=d.eq(e);if(1!=g.children().length||!g.children().eq(0).is("template"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing <template>). ",g);if(this.display=g.children().html().trim(),e++,e<d.length){if("rdf:RDF"!=d.eq(e).prop("tagName"))throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected <rdf:rdf> in final position. ). ",d);this.rdf=d.eq(e).html().trim(),e++}if(e!=d.length)throw new KAT.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <fields>, <display> and <rdf:RDF>). ",d)},KAT.model.Concept.prototype.getDefault=function(){var a={};return $.each(this.fields,function(b){b.type==KAT.model.Field.types.text?a[b.value]=b["default"]:b.type==KAT.model.Field.types.select?a[b.value]=""===b["default"]?b.validation[0]:b["default"]:b.type==KAT.model.Field.types.reference&&(a[b.value]="")}),a},KAT.model.Concept.prototype.getFullName=function(){return this.KAnnSpec.getFullName()+"."+this.name},KAT.model.Concept.prototype.getField=function(a){if(a=KAT.model.nameNormaliser(a),!KAT.model.nameRegEx.test(a))return!1;for(var b=0;b<this.fields.length;b++)if(this.fields[b].name==a)return this.fields[b];return!1},KAT.model.Field=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.Field("KAT.model.Field: Invalid XML (Unable to parse XML). ",this.xml)}if(this.concept=b,"string"!=typeof this.xml.attr("name"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML (Missing name attribute for <field>). ",this.xml);if(this.name=KAT.model.nameNormaliser(this.xml.attr("name")),!KAT.model.nameRegEx.test(this.name))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.concept.getField(this.name))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML (Field '"+this.getFullName()+"' already exists). ",this.xml);if("string"!=typeof this.xml.attr("type"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing type attribute for <field>). ",this.xml);if("string"!=typeof this.xml.attr("rdfpred"))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing rdfpred attribute for <field>). ",this.xml);if(!KAT.model.Field.types.hasOwnProperty(this.xml.attr("type")))throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unknown <field> type). ",this.xml);this.type=KAT.model.Field.types[this.xml.attr("type")],this.rdf_pred=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdfpred"),this.concept.KAnnSpec.xml),this.minimum=1,this.maximum=1,this.value="",this["default"]="",this.documentation="",this.validation=void 0;var d=!1,e=!1,f=!1,g=!1,h=!1;if(this.validation=this.type==KAT.model.Field.types.text?new RegExp(".*"):[],this.xml.children().each(function(a,b){if(b=$(b),b.is("value")){if(d)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <value> tag). ",b);d=!0,this.value=b.text()}else if(b.is("number")){if(g)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <number> tag). ",b);g=!0;try{this.minimum=parseInt(b.attr("atleast"))}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atleast property must be a number). ",b)}try{this.maximum=parseInt(b.attr("atmost"))}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atmost property must be a number). ",b)}}else if(b.is("documentation")){if(h)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <documentation> tag). ",b);h=!0,this.documentation=b.text().trim()}else if(b.is("default")&&this.type==KAT.model.Field.types.text){if(e)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <default> tag). ",b);e=!0,this["default"]=b.text()}else if(b.is("validation")&&this.type==KAT.model.Field.types.text){if(f)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <validation> tag). ",b);f=!0;try{this.validation=new RegExp(b.text())}catch(c){throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unregonised regular expression). ",b)}}else if(b.is("referencedType")&&this.type==KAT.model.Field.types.reference)this.validation.push(b.text());else if(b.is("option")&&this.type==KAT.model.Field.types.select)this.validation.push(new KAT.model.Option(b,this));else{if(!b.is("defaultoption")||this.type!=KAT.model.Field.types.select)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unexpected tag '"+b.prop("tagName")+"'). ",b);this.validation.push(new KAT.model.Option(b,this))}}.bind(this)),d||(this.value=this.name),this.type==KAT.model.Field.types.select&&0===this.validation.length)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (KAT.model.Field.types.select must have a non-empty list of options. ). ",c);for(var i=0;i<this.concept.fields.length;i++)if(this.concept.fields[i].value==this.value)throw new KAT.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Value '"+this.value+"' already used by field '"+this.concept.fields[i].getFullName()+"'). ",this.xml)},KAT.model.Field.prototype.getFullName=function(){return this.concept.getFullName()+"."+this.name},KAT.model.Field.types={reference:"reference",select:"select",text:"text"},KAT.model.Option=function(a,b){try{this.xml=jQuery(a)}catch(c){throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Unable to parse XML). ",this.xml)}if(this.field=b,1!=this.xml.find("value").length)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Expected exactly one <value>. )",this.xml);this.value=this.xml.find("value").text();for(var d=0;d<this.field.validation.length;d++)if(this.field.validation[d].value==this.value)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Value '"+this.value+"' already used). ",this.xml);if(this.xml.is("defaultoption")){if(""!==this.field["default"])throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Default already exists)",this.xml);this.field["default"]=this.value}if(this.rdf_obj=!1,"string"==typeof this.xml.attr("rdfobj")&&(this.rdf_obj=KAT.rdf.resolveWithNameSpace(this.xml.attr("rdfobj"),this.field.concept.KAnnSpec.xml)),this.documentation=this.xml.find("documentation").text(),this.xml.children().length>2)throw new KAT.model.ParsingError("KAT.model.Option: Invalid XML (Too many children. )",this.xml)},KAT.gui=function(a,b){b.init(),this.collection=b,this.element=a},KAT.gui.prototype.getSelection=function(){var a=window.getSelection().getRangeAt(0),b=this.element,c=KAT.gui.getXPath(b,a.commonAncestorContainer),d=KAT.gui.getXPath(b,a.startContainer.parentElement),e=KAT.gui.getXPath(b,a.endContainer.parentElement);return{container:c,start:d,startOffset:a.startOffset,end:e,endOffset:a.endOffset}},KAT.gui.getXPath=function(a,b){for(var c=$(b).get(0),d=$(a).get(0),e=[];c&&c!==d;c=c.parentNode){for(var f=0,g=c.previousSibling;g;g=g.previousSibling)g.nodeType!=Node.DOCUMENT_TYPE_NODE&&g.nodeName==c.nodeName&&++f;var h=c.nodeName.toLowerCase(),i=f?"["+(f+1)+"]":"";e.splice(0,0,h+i)}return e.length?"/"+e.join("/"):null},KAT.gui.resolveXPath=function(a,b){for(var c,d,e,f,g=$(a).get(0),h=b.split("/").splice(1),i=function(a){return(a.tagName||a.nodeName).toLowerCase()==d.toLowerCase()},j=0;j<h.length;j++)if(c=h[j],d=c.split("[")[0],e=parseInt((c.split("[")[1]||"1]").split("]")[0])-1,f=g,g=Array.prototype.filter.call(g.children,i)[e],void 0===g)return void console.log("undefined",f,c,d,e);return g},KAT.gui.prototype.getRange=function(a){var b=$(KAT.gui.resolveXPath(this.element,a.container)),c=b.find("*").andSelf(),d=c.index(KAT.gui.resolveXPath(this.element,a.start)),e=$(KAT.gui.resolveXPath(this.element,a.end)),f=c.index(e);return c=c.slice(d,f),c.filter(function(a,b){var d=$(b).children();return d.length==c.filter(d).length}).add(e.find("*").andSelf())},KAT.gui.dialog=function(a,b,c,d){var e={},f=$([]);$.each(c,function(a){f=f.add($("<button class='btn btn-"+(0===a?"primary":"default")+"'>").text(c[a]).click(function(){d.call(e,c[a],a)}))}),f=$(f.get().reverse());var g=$('<h4 class="modal-title"></h4>').text(a),h=$("<p>").text(b),i=$('<div class="modal hide large">').append($('<div class="modal-dialog">').append($('<div class="modal-content">').append($('<div class="modal-header>').append($('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>').click(function(){return d.call(e,"",-1),!1}),g),$('<div class="modal-body">').append(h),$('<div class="modal-footer">').append(f))));return i.appendTo($("<div>").BS().appendTo("body")).modal().on("hidden",function(){JOBAD.UI.BSStyle()}),JOBAD.UI.BSStyle(),e={$dialog:i,$title:g,$content:h,$buttons:f,close:function(){i.one("hidden.bs.modal",function(){i.remove()}).modal("hide")}}},KAT.gui.selectDialog=function(a,b,c,d,e){var f,g=0;if("function"==typeof d&&"undefined"==typeof e&&(e=d,d=function(){return""}),Array.isArray(d)){var h=d;d=function(a,b){return h[b]}}$self=KAT.gui.dialog(a,b,["OK","Cancel"],function(a,b){$self.close(),0===b?e.call($self,c[g],g):e.call($self,"",-1)});var i=$("<span>"),j=$("<span style='margin-left: 10px; '>"),k=$('<ul class="dropdown-menu" role="menu">'),l=$("<div class='dropdown'>").append($('<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">').append(i,'<span class="caret"></span>'),k,j);return $.each(c,function(a,b){k.append($('<li role="presentation">').append($('<a role="menuitem" tabindex="-1" href="#">').text(b).click(function(){g=a,f()})))}),$self.$content.empty().append($("<h3>").text(b),l),f=function(){i.text(c[g]),j.text(d(c[g],g))},f(),$self},KAT.sidebar={},KAT.sidebar.init=function(){var a=-230,b=jQuery(window).height(),c=jQuery("<div>").addClass("collapsible").append($("<ul>").addClass("KATMenuItems")).css({position:"fixed",right:a,height:b-10}).prependTo("body"),d=$("<button>").text("«").css({height:b-10}).click(function(){KAT.sidebar.collapsibleStatus?(KAT.sidebar.collapsibleStatus=!1,jQuery(this).text("«").parent().animate({right:a},300),jQuery("body").css({width:jQuery(window).width()-50})):(KAT.sidebar.collapsibleStatus=!0,jQuery(this).text("»").parent().animate({right:"0"},300),jQuery("body").css({width:jQuery(window).width()-260}))}).prependTo(c);jQuery("body").css({width:jQuery(window).width()-50}),jQuery(window).resize(function(){b=jQuery(window).height(),c.css({position:"fixed",right:a,height:b-10}),d.css({height:b-10}),jQuery("body").css({width:jQuery(window).width()-50})})},KAT.sidebar.genNewAnnotationForm=function(a,b,c){var d=$("<li>").addClass("currentForm").append("<b> Enter Annotation Details</b><br>").appendTo(".KATMenuItems"),e=jQuery.map(c.fields,function(b){var c,e=b.validation,f=b.value;if(d.append(jQuery("<span>").text(f)),b.type===KAT.model.Field.types.text&&(c=jQuery("<input type='text'>").appendTo(d)),b.type===KAT.model.Field.types.select&&(c=jQuery("<select>").appendTo(d),$.each(e,function(a,b){jQuery("<option>").text(b.value).val(a).appendTo(c)})),b.type===KAT.model.Field.types.reference){c=jQuery("<select>").appendTo(d);var g=a.store.filterByConcept.apply(a.store,e);jQuery.each(g,function(a,b){$("<option>").text(b.uuid).val(b.uuid).appendTo(c)})}return c});$("<input type='button'>").val("Add").appendTo(d).click(function(){var f={};$.each(c.fields,function(b,c){var d=e[b];f[c.value]=c.type==KAT.model.Field.types.reference?[a.store.find(d.val())]:c.type==KAT.model.Field.types.select?[c.validation[d.val()]]:[d.val()]}),d.remove();var g=a.store.addNew(b,c,f);g.draw()})},KAT.sidebar.collapsibleStatus=!1,KAT.storage={},KAT.storage.Store=function(a){this.collection=a.collection,this.gui=a,this.annotations=[]},KAT.storage.Store.prototype.addNew=function(a,b,c){var d=new KAT.storage.Annotation(this,a,b,c);return this.annotations.push(d),d},KAT.storage.Store.prototype.addFromJSON=function(a){var b=new KAT.storage.Annotation(this,KAT.storage.Store.UUID2Selection(a.uuid),this.collection.getConcept(a.concept));return b.values=a.values,this.annotations.push(b),b},KAT.storage.Store.prototype.filterByConcept=function(){var a=[],b=jQuery.makeArray(arguments),c=0===b.length;return jQuery.each(this.annotations,function(d,e){(c||-1!=b.indexOf(e.concept.name))&&a.push(e)}),console.log(a),a},KAT.storage.Store.prototype.find=function(a){for(var b=0;b<this.annotations.length;b++)if(this.annotations[b].uuid==a)return this.annotations[b];return void 0},KAT.storage.Store.prototype.findfromElement=function(a){for(var b=$(a).parentsUntil(this.element).andSelf().add(this.element),c=[],d=[],e=b.length-1;e>=0;e--)for(var f=b.eq(e).data("KAT.Annotation.UUID")||[],g=0;g<f.length;g++)-1==c.indexOf(f[g])&&(c.push(f[g]),d.push(this.find(f[g])));return d},KAT.storage.Store.prototype.sanityCheck=function(){return!0},KAT.storage.Store.prototype.toRDF=function(a){var b=$(KAT.rdf.create("rdf:RDF")).attr("xmlns:kat","https://github.com/KWARC/KAT/").attr("xmlns:rdf","http://www.w3.org/1999/02/22-rdf-syntax-ns#"),c="kat_run";b.append($(KAT.rdf.create("rdf:Description")).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",c)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",c).append(KAT.rdf.attr($(KAT.rdf.create("rdf:type")),"rdf:resource","kat:run"),KAT.rdf.attr($("<kat:date />").text((new Date).toISOString()),"rdf:datatype","xs:dateTime"),$("<kat:tool>").text("KAT"),$("<kat:runid>").text("0")));var d={};return jQuery.each(this.annotations,function(e,f){var g=f.concept.KAnnSpec;d[g.rdf_nodeid]||(d[g.rdf_nodeid]=!0,g.xml.find("annotation").each(function(){$.each(this.attributes,function(a,c){var d=c.name,e=c.value;d.startsWith("xmlns:")&&b.attr(d,e)})}),b.append($(KAT.rdf.create("rdf:Description")).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",g.rdf_nodeid)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",g.rdf_nodeid).append(KAT.rdf.attr($("<rdf:type>"),"rdf:resource","kat:kannspec"),$("<kat:kannspec-name>").text(g.name),$("<kat:kannspec-URI>").text("about:blank")))),b.append($(f.toRDF(a,c)).children())}),b.get(0).outerHTML},KAT.storage.Store.Selection2UUID=function(a){return"cse("+a.container+","+a.start+","+a.end+")"},KAT.storage.Store.UUID2Selection=function(a){var b="cse(",c=")",d=a.substring(0,b.length),e=a.substring(a.length-c.length);return d!==b||e!==c?!1:(a=a.substring(b.length,a.length-c.length),a=a.split(","),3!==a.length?!1:{container:a[0],start:a[1],end:a[2],startOffset:0,endOffset:0})},KAT.storage.Annotation=function(a,b,c,d){this.store=a;var e=KAT.storage.Store.Selection2UUID(b);if(this.store.find(e))throw new Error("Annotation with given uuid already exists. ");this.uuid=e,this.selection=b,this.concept=c,this.rdf_id="KAT_"+(new Date).getTime()+"_"+Math.floor(1e4*Math.random()),d="undefined"!=typeof d?d:c.getDefault(),this.values=d},KAT.storage.Annotation.prototype["delete"]=function(){this.undraw();for(var a=0;a<this.store.annotations.length;a++)if(this.store.annotations[a].uuid==this.uuid){this.store.annotations.splice(a,1);break}this.store.sanityCheck()},KAT.storage.Annotation.prototype.draw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.addClass("KAT-selection").each(function(){var b=$(this),c=b.data("KAT.Annotation.UUID")||[];c.push(a.uuid),b.data("KAT.Annotation.UUID",c)})},KAT.storage.Annotation.prototype.flash=function(){this.store.gui.getRange(this.selection).stop().animate({backgroundColor:"red"},1500,function(){$(this).css("background-color","")})},KAT.storage.Annotation.prototype.edit=function(){alert("Unimplemented!")},KAT.storage.Annotation.prototype.undraw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.removeClass("KAT-selection").each(function(){var b=$(this),c=$(this).data("KAT.Annotation.UUID")||[],d=c.indexOf(a.uuid);~d&&(c.splice(d,1),b.data("KAT.Annotation.UUID",c))})},KAT.storage.Annotation.prototype.toJSON=function(){return{uuid:this.uuid,concept:this.concept.getFullName(),values:this.values}},KAT.storage.Annotation.prototype.toRDF=function(a,b){var c=this,d=this.concept,e=$(KAT.rdf.create("rdf:RDF")),f=(KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:about",a+"#"+encodeURIComponent(KAT.storage.Store.Selection2UUID(this.selection))).appendTo(e).append(KAT.rdf.attr($(KAT.rdf.create("kat:annotation")),"rdf:nodeID",this.rdf_id)),KAT.rdf.attr($(KAT.rdf.create("rdf:Description")),"rdf:nodeID",this.rdf_id).appendTo(e).append(KAT.rdf.attr($(KAT.rdf.create("kat:run")),"rdf:nodeID",b),KAT.rdf.attr($(KAT.rdf.create("kat:kannspec")),"rdf:nodeID",d.KAnnSpec.rdf_nodeid),$(KAT.rdf.create("kat:concept")).text(d.name)));return jQuery.each(d.fields,function(a,b){var e=c.values[b.value],g=jQuery.isArray(e)?e:[e];jQuery.each(g,function(a,c){b.type==KAT.model.Field.types.text?$(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).text(c).appendTo(f):b.type==KAT.model.Field.types.reference?(KAT.rdf.attr($(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).appendTo(f),"rdf:nodeID",c.rdf_id),console.log(c)):b.type==KAT.model.Field.types.select&&(console.log(c),KAT.rdf.attr($(KAT.rdf.create(KAT.rdf.buildNameSpace(b.rdf_pred,d.KAnnSpec.xml))).appendTo(f),"rdf:resource",c.rdf_obj?c.rdf_obj:c.value))})}),e.get(0)},KAT.module={info:{identifier:"KAT.module",title:"KAT module",author:"The KWARC group",description:"A module for KAT",url:"http://kwarc.github.io/KAT",version:"2.0",dependencies:[],externals:{js:[],css:[]},async:!1,hasCleanNamespace:!1},init:function(a,b){this.store=b,this.gui=this.store.gui},contextMenuEntries:function(a){var b=this,c="Add new Annotation",d="Delete Annotation",e="Highlight Annotation",f="Edit Annotation",g={};g[c]=!1,g[d]={},g[e]={},g[f]={};var h;try{h=this.gui.getSelection()}catch(i){}h&&(h.start!=h.end||h.startOffset!=h.endOffset)&&(g[c]={},$.each(this.gui.collection.findConcepts(),function(a,d){g[c][d.getFullName()]=function(){KAT.sidebar.genNewAnnotationForm(b,h,d)}}));var j=this.store.findfromElement(a);return 0!==j.length?$.each(j,function(a,b){g[d][b.uuid]=function(){b["delete"]()},g[e][b.uuid]=function(){b.flash()},g[f][b.uuid]=function(){b.edit()}}):(g[d]=!1,g[e]=!1,g[f]=!1),g.Storage={Import:function(){var a=prompt("Paste the annotations below: ");if(a){a=JSON.parse(a);for(var c=0;c<a.length;c++)a[c]=b.store.addFromJSON(a[c]),a[c].draw()}},Export:function(){var a=b.store.toRDF();console.log(a),prompt("Press CTRL+C to export annotations: ",a)}},g}},JOBAD.modules.register(KAT.module);
>>>>>>> ba436cc69feec0359dcf63446ea73e77adf0926f
//# sourceMappingURL=KAT.min.js.map