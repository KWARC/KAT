/**
Copyright (c) 2014-15 by the KWARC Group (http://kwarc.info)

KAT is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

KAT is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with KAT.  If not, see <http://www.gnu.org/licenses/>
*/

!function(a,b){b.KAT=a;var c=a,d=b.jQuery;c.rdf={},c.rdf.kat_namespace="https://github.com/KWARC/KAT/",c.rdf.rdf_namespace="http://www.w3.org/1999/02/22-rdf-syntax-ns#",c.rdf.create=function(a){return document.createElementNS(c.rdf.rdf_namespace,a)},c.rdf.attr=function(a,b,c){return d(a).get(0).setAttribute(b,c),a},c.rdf.resolveWithNameSpace=function(a,b){var c=a.split(":");if(2==c.length){var e=d(b).find("annotation").eq(0);return e.attr("xmlns:"+c[0])+c[1]}return a},c.rdf.buildNameSpace=function(a,b){for(var c,e,f,g=d(b).find("annotation").get(0)||d(b).get(0),h=0;h<g.attributes.length;h++)if(c=g.attributes[h],"xmlns"==c.name.substring(0,"xmlns".length)&&(e=c.name.split(":")[1]||"",a.startsWith(c.value)))return f=a.substring(c.value.length),""!==e?e+":"+f:f;return a},c.rdf.findById=function(a,b){return jQuery("rdf\\:Description",a).filter(function(){return jQuery(this).attr("rdf:nodeID")===b})},c.model={},c.model.nameRegExS="(?:\\w|\\d|\\-|\\_|\\+)+",c.model.nameRegEx=new RegExp("^"+c.model.nameRegExS+"$"),c.model.nameRegEx2=new RegExp("^("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")$"),c.model.nameRegEx3=new RegExp("^("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")\\.("+c.model.nameRegExS+")$"),c.model.nameNormaliser=function(a){return a},c.model.ParsingError=function(a,b){var c=Error.apply(this,[a]);return c.name=this.name="KAT.model.ParsingError",c.node=this.node=b,b instanceof jQuery&&(c.node=this.node=b.toArray()),this.message=c.message,Object.defineProperty(this,"stack",{get:function(){return c.stack}}),this},function(){var a=function(){};a.prototype=Error.prototype,c.model.ParsingError.prototype=new a}(),c.model.KAnnSpecCollection=function(){this.KAnnSpecs=[]},c.model.KAnnSpecCollection.prototype.addKAnnSpec=function(a){return this.getKAnnSpec(a.name)?!1:(this.KAnnSpecs.push(a),a)},c.model.KAnnSpecCollection.prototype.addNewKAnnSpec=function(a,b){return this.addKAnnSpec(new c.model.KAnnSpec(a,b,this))},c.model.KAnnSpecCollection.prototype.init=function(){return d.each(this.KAnnSpecs,function(a,b){d.each(b.concepts,function(a,b){d.each(b.fields,function(){if(this.type==c.model.Field.types.reference)for(var a=0;a<this.validation.length;a++){var b=this.validation[a];b instanceof c.model.Concept&&(b=b.getFullName());var d=this.concept.KAnnSpec.getConcept(b);if(d||(d=this.concept.KAnnSpec.collection.getConcept(b)),!d)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Concept not found: '"+b+"'). ",this.xml);this.validation[a]=d}}.bind(b))}.bind(b))}),this},c.model.KAnnSpecCollection.prototype.getKAnnSpec=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.KAnnSpecs.length;b++)if(this.KAnnSpecs[b].name==a)return this.KAnnSpecs[b];return!1},c.model.KAnnSpecCollection.prototype.getConcept=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx2.test(a))return!1;a=a.match(c.model.nameRegEx2);var b=this.getKAnnSpec(a[1]);return b?b.getConcept(a[2]):!1},c.model.KAnnSpecCollection.prototype.findConcepts=function(){for(var a=[],b=0;b<this.KAnnSpecs.length;b++)for(var c=0;c<this.KAnnSpecs[b].concepts.length;c++)a.push(this.KAnnSpecs[b].concepts[c]);return a},c.model.KAnnSpecCollection.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx3.test(a))return!1;a=a.match(c.model.nameRegEx3);var b=this.getKAnnSpec(a[1]);if(!b)return!1;var d=b.getConcept(a[2]);return d?d.getField(a[3]):!1},c.model.KAnnSpecCollection.prototype.assignDisplayColour=function(){var a=function(a){var b="0123456789ABCDEF";return String(b.substr(a>>4&15,1))+b.substr(15&a,1)},b=function(b,c,d){return"#"+a(b)+a(c)+a(d)},c=function(a,c,d,e){for(var f=128,g=127,h=56,i=[],j=0;h>j;++j){var k=Math.sin(a*j+c)*g+f,l=Math.sin(a*j+d)*g+f,m=Math.sin(a*j+e)*g+f;i.push(b(k,l,m))}return i},d=function(a,b){for(var c=Math.floor(b/a),d=[],e=c;b>=e;)d.push(e),e=c+d[d.length-1];var f=Math.floor(b/2),g=d[Math.floor(d.length/2)],h=g-f;return d.length%2===0&&(h=Math.floor(h/2)),d.forEach(function(a,b){d[b]=a-h}),d},e=function(a){var b=c(.1,0,2,4),e=d(a,b.length),f=[];for(i=0;i<e.length;i++)f.push(b[e[i]]);return f},f=this.findConcepts(),g=f.length,h=e(g);for(i=0;i<g;i++)f[i].displayColour=h[i]},c.model.KAnnSpec=function(a,b,e){try{this.xml=jQuery(a)}catch(f){throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Unable to parse XML). ",this.xml)}if(1!=this.xml.children().length||!this.xml.children().eq(0).is("annotation"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML (Expected exactly one top-level <annotation>). ",this.xml);if(this.url=c.storage.resolve(b),this.name=c.model.nameNormaliser(this.xml.children().eq(0).attr("name")),this.rdf_nodeid="KAT_"+(new Date).getTime()+"_"+this.name,!this.name||!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.KAnnSpec: Unable to create KAnnSpec ('"+this.name+"' is not a valid name). ",this.xml);var g=this.xml.children().eq(0);if(g.children().length<=1||!g.children().eq(0).is("documentation"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected exactly one <documentation>). ",g);this.collection=e,this.documentation=g.children().eq(0).text().trim(),this.concepts=[],g.children().slice(1).each(function(a,b){if(b=d(b),!b.is("concept"))throw new c.model.ParsingError("KAT.model.KAnnSpec: Invalid XML for KAnnSpec '"+this.getFullName()+"' (Expected child tag <concept>). ",b);this.concepts.push(new c.model.Concept(b,this))}.bind(this))},c.model.KAnnSpec.prototype.getFullName=function(){return this.name},c.model.KAnnSpec.prototype.getConcept=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.concepts.length;b++)if(this.concepts[b].name==a)return this.concepts[b];return!1},c.model.KAnnSpec.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx2.test(a))return!1;a=a.match(c.model.nameRegEx2);var b=this.getConcept(a[1]);return b?b.getField(a[2]):!1},c.model.Concept=function(a,b){try{this.xml=jQuery(a)}catch(d){throw new c.model.ParsingError("KAT.model.Concept: Invalid XML (Unable to parse XML). ",this.xml)}if(this.KAnnSpec=b,"string"!=typeof this.xml.attr("name"))throw new c.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing name attribute for <concept>). ",this.xml);if("string"!=typeof this.xml.attr("rdftype"))throw new c.model.ParsingError("KAT.model.Concept: Invalid Invalid XML (Missing rdftype attribute for <concept>). ",this.xml);if(this.name=c.model.nameNormaliser(this.xml.attr("name")),!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.KAnnSpec.getConcept(this.name))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML (Concept '"+this.getFullName()+"' already exists). ",this.xml);if(this.rdf_type=c.rdf.resolveWithNameSpace(this.xml.attr("rdftype"),this.KAnnSpec.xml),1!=this.xml.length||!this.xml.is("concept"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected exactly one <concept> tag). ",this.xml);this.documentation="",this.fields=[],this.displayColour="",this.display="";var e=this.xml.children(),f=0;if(e.length<2)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <field>, <display> and <rdf:rdf>). ",e);e.eq(f).is("documentation")&&(this.documentation=e.eq(f).text().trim(),f++);for(var g=!1;e.eq(f).is("field")&&f<e.length;)g=!0,this.fields.push(new c.model.Field(e.eq(f),this)),f++;if(!g)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing at least one declared <field>). ",e);if(!e.eq(f).is("display"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing required <display>). ",e);var h=e.eq(f);if(1!=h.children().length||!h.children().eq(0).is("template"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Missing <template>). ",h);if(this.display=h.children().html().trim(),f++,f<e.length){if("rdf:RDF"!=e.eq(f).prop("tagName"))throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected <rdf:rdf> in final position. ). ",e);this.rdf=e.eq(f).html().trim(),f++}if(f!=e.length)throw new c.model.ParsingError("KAT.model.Concept: Invalid XML for concept '"+this.getFullName()+"' (Expected at least 2 of <documentation>, <fields>, <display> and <rdf:RDF>). ",e)},c.model.Concept.prototype.getDefault=function(){var a={};return d.each(this.fields,function(b){b.type==c.model.Field.types.text?a[b.value]=b["default"]:b.type==c.model.Field.types.select?a[b.value]=""===b["default"]?b.validation[0]:b["default"]:b.type==c.model.Field.types.reference&&(a[b.value]="")}),a},c.model.Concept.prototype.getFullName=function(){return this.KAnnSpec.getFullName()+"."+this.name},c.model.Concept.prototype.getField=function(a){if(a=c.model.nameNormaliser(a),!c.model.nameRegEx.test(a))return!1;for(var b=0;b<this.fields.length;b++)if(this.fields[b].name==a)return this.fields[b];return!1},c.model.Field=function(a,b){try{this.xml=jQuery(a)}catch(e){throw new c.model.Field("KAT.model.Field: Invalid XML (Unable to parse XML). ",this.xml)}if(this.concept=b,"string"!=typeof this.xml.attr("name"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML (Missing name attribute for <field>). ",this.xml);if(this.name=c.model.nameNormaliser(this.xml.attr("name")),!c.model.nameRegEx.test(this.name))throw new c.model.ParsingError("KAT.model.Field: Invalid XML ('"+this.getFullName()+"' is not a valid name). ",this.xml);if(this.concept.getField(this.name))throw new c.model.ParsingError("KAT.model.Field: Invalid XML (Field '"+this.getFullName()+"' already exists). ",this.xml);if("string"!=typeof this.xml.attr("type"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing type attribute for <field>). ",this.xml);if("string"!=typeof this.xml.attr("rdfpred"))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Missing rdfpred attribute for <field>). ",this.xml);if(!c.model.Field.types.hasOwnProperty(this.xml.attr("type")))throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unknown <field> type). ",this.xml);this.type=c.model.Field.types[this.xml.attr("type")],this.rdf_pred=c.rdf.resolveWithNameSpace(this.xml.attr("rdfpred"),this.concept.KAnnSpec.xml),this.minimum=1,this.maximum=1,this.value="",this["default"]="",this.documentation="",this.validation=void 0;var f=!1,g=!1,h=!1,i=!1,j=!1;if(this.validation=this.type==c.model.Field.types.text?new RegExp(".*"):[],this.xml.children().each(function(a,b){if(b=d(b),b.is("value")){if(f)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <value> tag). ",b);f=!0,this.value=b.text()}else if(b.is("number")){if(i)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <number> tag). ",b);i=!0;try{this.minimum=parseInt(b.attr("atleast"))}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atleast property must be a number). ",b)}try{this.maximum=parseInt(b.attr("atmost"))}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (atmost property must be a number). ",b)}}else if(b.is("documentation")){if(j)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <documentation> tag). ",b);j=!0,this.documentation=b.text().trim()}else if(b.is("default")&&this.type==c.model.Field.types.text){if(g)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <default> tag). ",b);g=!0,this["default"]=b.text()}else if(b.is("validation")&&this.type==c.model.Field.types.text){if(h)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Double <validation> tag). ",b);h=!0,this.validation=b.text(),"^"!=this.validation[0]&&(this.validation="^"+this.validation),"$"!=this.validation[this.validation.length-1]&&(this.validation=this.validation+"$");try{this.validation=new RegExp(this.validation)}catch(e){throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unregonised regular expression). ",b)}}else if(b.is("referencedType")&&this.type==c.model.Field.types.reference)this.validation.push(b.text());else if(b.is("option")&&this.type==c.model.Field.types.select)this.validation.push(new c.model.Option(b,this));else{if(!b.is("defaultoption")||this.type!=c.model.Field.types.select)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Unexpected tag '"+b.prop("tagName")+"'). ",b);this.validation.push(new c.model.Option(b,this))}}.bind(this)),f||(this.value=this.name),this.type==c.model.Field.types.select&&0===this.validation.length)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (KAT.model.Field.types.select must have a non-empty list of options. ). ",e);for(var k=0;k<this.concept.fields.length;k++)if(this.concept.fields[k].value==this.value)throw new c.model.ParsingError("KAT.model.Field: Invalid XML for field '"+this.getFullName()+"' (Value '"+this.value+"' already used by field '"+this.concept.fields[k].getFullName()+"'). ",this.xml)},c.model.Field.prototype.getFullName=function(){return this.concept.getFullName()+"."+this.name},c.model.Field.types={reference:"reference",select:"select",text:"text"},c.model.Option=function(a,b){try{this.xml=jQuery(a)}catch(d){throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Unable to parse XML). ",this.xml)}if(this.field=b,1!=this.xml.find("value").length)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Expected exactly one <value>. )",this.xml);this.value=this.xml.find("value").text();for(var e=0;e<this.field.validation.length;e++)if(this.field.validation[e].value==this.value)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Value '"+this.value+"' already used). ",this.xml);if(this.xml.is("defaultoption")){if(""!==this.field["default"])throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Default already exists)",this.xml);this.field["default"]=this.value}if(this.rdf_obj=!1,"string"==typeof this.xml.attr("rdfobj")&&(this.rdf_obj=c.rdf.resolveWithNameSpace(this.xml.attr("rdfobj"),this.field.concept.KAnnSpec.xml)),this.documentation=this.xml.find("documentation").text(),this.xml.children().length>2)throw new c.model.ParsingError("KAT.model.Option: Invalid XML (Too many children. )",this.xml)},c.gui=function(a,b){b.init(),this.collection=b,this.element=a},c.gui.prototype.getSelection=function(){var a=window.getSelection().getRangeAt(0),b=this.element,d=function(a){return 3==a.nodeType?a.parentElement:a},e=c.gui.getXPath(b,d(a.commonAncestorContainer)),f=c.gui.getXPath(b,d(a.startContainer)),g=c.gui.getXPath(b,d(a.endContainer)),h={container:e,start:f,startOffset:a.startOffset,end:g,endOffset:a.endOffset,isEmpty:!1};return f==g&&a.startOffset==a.endOffset&&(h.isEmpty=!0),h},c.gui.getXPath=function(a,b){var c=d(b).get(0),e=d(a).get(0);if(c.hasAttribute("id"))return"//*[@id='"+c.id+"']";for(var f=[];c&&c!==e;c=c.parentNode){for(var g=0,h=c.previousSibling;h;h=h.previousSibling)h.nodeType!=Node.DOCUMENT_TYPE_NODE&&h.nodeName==c.nodeName&&++g;var i=c.nodeName.toLowerCase(),j=g?"["+(g+1)+"]":"";f.splice(0,0,i+j)}return f.length?"/"+f.join("/"):null},c.gui.resolveXPath=function(a,b){var c=b.match(/^\/\/\*\[@id='([^']+)'\]$/);if(c)return document.getElementById(c[1]);for(var e,f,g,h,i=d(a).get(0),j=b.split("/").splice(1),k=function(a){return(a.tagName||a.nodeName).toLowerCase()==f.toLowerCase()},l=0;l<j.length;l++)if(e=j[l],f=e.split("[")[0],g=parseInt((e.split("[")[1]||"1]").split("]")[0])-1,h=i,i=Array.prototype.filter.call(i.children,k)[g],void 0===i)return void console.log("undefined",h,e,f,g);return i},c.gui.prototype.getRange=function(a){var b=d(c.gui.resolveXPath(this.element,a.container)),e=b.find("*").andSelf(),f=e.index(c.gui.resolveXPath(this.element,a.start)),g=d(c.gui.resolveXPath(this.element,a.end)),h=e.index(g);return e=e.slice(f,h),e.filter(function(a,b){var c=d(b).children();return c.length==e.filter(c).length}).add(g.find("*").andSelf())},c.gui.nodeInRange=function(a,b){var c;if(a.intersectsNode)return a.intersectsNode(b);c=b.ownerDocument.createRange();try{c.selectNode(b)}catch(d){c.selectNodeContents(b)}return-1==a.compareBoundaryPoints(Range.END_TO_START,c)&&1==a.compareBoundaryPoints(Range.START_TO_END,c)},c.gui.dialog=function(a,b,c,e){var f={},g=d([]);d.each(c,function(a){g=g.add(d("<button class='btn btn-"+(0===a?"primary":"default")+"'>").text(c[a]).click(function(){e.call(f,c[a],a)}))}),g=d(g.get().reverse());var h=d('<h4 class="modal-title"></h4>').text(a),i=d("<p>").text(b),j=d('<div class="modal fade">').append(d('<div class="modal-dialog">').append(d('<div class="modal-content">').append(d('<div class="modal-header>').append(d('<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>').click(function(){return e.call(f,"",-1),!1}),h),d('<div class="modal-body">').append(i),d('<div class="modal-footer">').append(g))));return j.appendTo(d("<div>").appendTo("body")).modal(),f={$dialog:j,$title:h,$content:i,$buttons:g,close:function(){j.one("hidden.bs.modal",function(){j.remove()}).modal("hide")}}},c.gui.selectDialog=function(a,b,e,f,g){var h,i=0;if("function"==typeof f&&"undefined"==typeof g&&(g=f,f=function(){return""}),Array.isArray(f)){var j=f;f=function(a,b){return j[b]}}$self=c.gui.dialog(a,b,["OK","Cancel"],function(a,b){$self.close(),0===b?g.call($self,e[i],i):g.call($self,"",-1)});var k=d("<span>"),l=d("<span style='margin-left: 10px; '>"),m=d('<ul class="dropdown-menu" role="menu">'),n=d("<div class='dropdown'>").append(d('<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">').append(k,'<span class="caret"></span>'),m,l);return d.each(e,function(a,b){m.append(d('<li role="presentation">').append(d('<a role="menuitem" tabindex="-1" href="#">').text(b).click(function(){i=a,h()})))}),$self.$content.empty().append(d("<h3>").text(b),n),h=function(){k.text(e[i]),l.text(f(e[i],i))},h(),$self},c.sidebar={},c.sidebar.init=function(a){var b;b=c.sidebar.annotationMode?"Reading":"Annotation";var e=jQuery(window).height();c.sidebar.modeToggleButton=d("<button>").text("Enable "+b+" Mode").addClass("annotationToggle").addClass("btn btn-default").BS().click(function(){c.sidebar.toggleAnnotationMode()});var f=jQuery("<div>").addClass("collapsible").append(d("<div>").addClass("KATTitle").html("<h3>KWARC Annotation Tool</h3>"),d("<div>").addClass("KATSidebarButtons").append(c.sidebar.modeToggleButton,"<br/>","<br/>",d("<button>").text("Import Annotations").addClass("helpButton").addClass("btn btn-default").click(function(){a.showImportDialog()}),"<br/>","<br/>",d("<button>").text("Export Annotations").addClass("helpButton").addClass("btn btn-default").click(function(){a.showExportDialog()}),"<br/>","<br/>","<br/>"),d("<ul>").addClass("KATMenuItems")).css({position:"fixed",right:c.sidebar.hideWidth,height:e-10}).prependTo("body"),g=d("<button>").text("«").addClass("collapseToggle").css({height:e-10}).click(c.sidebar.toggleSidebar).prependTo(f);c.sidebar.showSidebar(),jQuery(window).resize(function(){e=jQuery(window).height(),f.css({position:"fixed",right:c.sidebar.hideWidth,height:e-10}),g.css({height:e-10})})},c.sidebar.showSidebar=function(){c.sidebar.extended=!0,jQuery(".collapseToggle").text("»").parent().animate({right:"0"},c.sidebar.animateLength)},c.sidebar.hideSidebar=function(){c.sidebar.extended=!1,jQuery(".collapseToggle").text("«").parent().animate({right:c.sidebar.hideWidth},c.sidebar.animateLength)},c.sidebar.toggleSidebar=function(){c.sidebar.extended?c.sidebar.hideSidebar():c.sidebar.showSidebar()},c.sidebar.toggleAnnotationMode=function(){c.sidebar.annotationMode=!c.sidebar.annotationMode;var a;c.sidebar.annotationMode?(a="Reading",c.sidebar.showSidebar()):a="Annotation",c.sidebar.modeToggleButton.text("Enable "+a+" Mode")},c.sidebar.generateAnnotationForm=function(a,b,e,f,g){c.sidebar.extended||c.sidebar.toggleSidebar();var h,i;"undefined"==typeof e?i="Enter":(i="Edit",h=e.values);var j=d("<li>").append("<h4> "+g.name+" - "+i+" Annotation Details</h4>").appendTo(".KATMenuItems"),k=[],l=function(){var a=!0;return jQuery.each(k,function(b,c){a=a&&c()}),a?p.removeAttr("disabled"):p.attr("disabled","disabled"),a},m=d("<form>").addClass("form-inline").appendTo(j).on("submit",function(a){return a.preventDefault(),p.click(),!1}),n=jQuery.map(g.fields,function(b){var f,g=d("<div>").appendTo(m);return jQuery.map([0],function(i){function j(a){a.preventDefault(),p(!0)}function m(a){a.preventDefault(),q(!0)}function n(a){var c=d(a.target).parent();c.prev("br").remove(),c.remove(),a.preventDefault(),z--,d.each(d(".plusButton."+b.name),function(a,b){d(b).removeAttr("disabled")})}function o(a){var c=d(a.target).parent().parent();c.prev("br").remove(),c.remove(),a.preventDefault(),z--,d.each(d(".plusButton."+b.name),function(a,b){d(b).removeAttr("disabled")})}function p(g){function i(a,b){jQuery("<option>").text(b.uuid).val(b.uuid).appendTo(f)}var j;if(y>z){if(g=g||!1,u=d("<div class='btn-group' role='group'>").appendTo(w),f=jQuery("<select>").attr("id",s).addClass("form-control").appendTo(u),b.type===c.model.Field.types.select){if(jQuery.each(b.validation,function(a,b){jQuery("<option>").text(b.value).val(a).appendTo(f)}),"undefined"!=typeof e){j=h[t];for(var k=0;k<b.validation.length;k++)b.validation[k].value===j[0].value&&f.val(k)}}else{var l=a.store.filterByConcept.apply(a.store,b.validation);jQuery.each(l,i),h&&(j=h[t],f.val(j[0].uuid))}if(d("<br>").appendTo(w),g){d("<button class='btn btn-default minusButton "+b.name+"' >").on("click",n).text("-").appendTo(u)}z++,z==y&&d.each(d(".plusButton."+b.name),function(a,b){d(b).attr("disabled","true")})}}function q(a){if(y>z){a=a||!1,v=d("<div>").addClass("input-group").appendTo(w),f=d("<input type='text'>").attr("id",s).addClass("tfield").addClass("form-control").appendTo(v).keyup(function(){l()});{var c=b.validation,e=d("<span>").addClass("input-group-btn").appendTo(v),g="<p>"+b.documentation+"</p><p>You are expected to match the following Regular Expression: </br>"+c+"</p>";d("<button type='button' class='btn btn-default'>").attr("data-container","#"+b.name).attr("title","Information").attr("data-content",g).text("?").popover({html:!0,toggle:"popover",placement:"top"}).appendTo(e)}if(k.push(function(){return r.removeClass("has-success has-error"),c.test(f.val())?(r.addClass("has-success"),!0):(r.addClass("has-error"),!1)}),d("<br>").appendTo(w),a){var h=d("<span class='input-group-btn'>").prependTo(v);d("<button class='btn btn-default minusButton "+b.name+"' >").on("click",o).text("-").appendTo(h)}z++,z==y&&d.each(d(".plusButton."+b.name),function(a,b){d(b).attr("disabled","true")})}}var r=d("<div id='"+b.name+random()+"'>").addClass("form-group").appendTo(g).css({overflow:"visible"}),s="KAT_form_"+(new Date).getTime()+"_"+Math.floor(1e4*Math.random()),t=b.value;d("<label>").addClass("control-label").attr("for",s).text(t).appendTo(r),r.append("&nbsp;");var u,v,w=d("<div>").appendTo(r),x=b.minimum||1,y=b.maximum||x,z=0;b.type===c.model.Field.types.text?!function(){for(;x>z;)if(q(),x>i&&y>1){var a=d("<span class='input-group-btn'>").prependTo(v);d("<button class='btn btn-default plusButton "+b.name+"' >").on("click",m).text("+").appendTo(a)}}():b.type===c.model.Field.types.select&&!function(){for(;x>z;)if(p(),x>i&&y>1){d("<button class='btn btn-default plusButton "+b.name+"' >").on("click",j).text("+").appendTo(u)}k.push(function(){return r.addClass("has-success"),!0})}(),b.type===c.model.Field.types.reference&&!function(){for(;x>z;)if(p(),x>i&&y>1){d("<button class='btn btn-default plusButton "+b.name+"' >").on("click",j).text("+").appendTo(u)}}()}),f});m.append("<br />");{var o=d("<div>").addClass("btn-group").appendTo(m),p=d("<button type='submit'>").addClass("btn btn-primary").text("Save").click(function(h){if(h.preventDefault(),l()){var i={};d.each(g.fields,function(b,d){var e=n[b];i[d.value]=d.type==c.model.Field.types.reference?[a.store.find(e.val())]:d.type==c.model.Field.types.select?[d.validation[e.val()]]:[e.val()]}),d(".popover").popover("destroy").remove(),j.remove();var k=b(f,g,i,e);return k.draw(),!1}}).appendTo(o);d("<button type='button'>").addClass("btn btn-danger").text("Cancel").click(function(){d(".popover").popover("destroy").remove(),j.remove()}).appendTo(o)}l()},c.sidebar.extended=!1,c.sidebar.annotationMode=!1,c.sidebar.hideWidth=-480,c.sidebar.animateLength=100,c.sidebar.modeToggleButton=void 0,c.sidebar.modeToggleButton=void 0,c.storage={},c.storage.resolve=function(a,b,c){var d,e,f,g=!1;"string"==typeof b&&(g=!0,d=arguments.callee(b,!0),e=jQuery("base").detach(),f=jQuery("<base>").attr("href",d).appendTo("head"));var h=document.createElement("div");h.innerHTML='<a href="'+jQuery("<span/>").text(a).html()+'">x</a>';var i=h.firstChild.href;return g&&(f.remove(),e.appendTo("head")),b!==!0&&c!==!0||"/"==i[i.length-1]||(i+="/"),i},c.storage.Store=function(a,b){this.collection=a.collection,this.gui=a,this.docURL=c.storage.resolve(b),this.annotations=[]},c.storage.Store.prototype.addNew=function(a,b,d){var e=new c.storage.Annotation(this,a,b,d);return this.annotations.push(e),e},c.storage.Store.prototype.addFromJSON=function(a){var b=new c.storage.Annotation(this,c.storage.Store.UUID2Selection(a.uuid),this.collection.getConcept(a.concept));return b.values=a.values,this.annotations.push(b),b},c.storage.Store.prototype.filterByConcept=function(){var a=[],b=jQuery.makeArray(arguments),c=0===b.length;return jQuery.each(this.annotations,function(d,e){(c||-1!=b.indexOf(e.concept.name))&&a.push(e)}),a},c.storage.Store.prototype.find=function(a){for(var b=0;b<this.annotations.length;b++)if(this.annotations[b].uuid==a)return this.annotations[b];return void 0},c.storage.Store.prototype.findfromElement=function(a){for(var b=d(a).parentsUntil(this.element).andSelf().add(this.element),c=[],e=[],f=b.length-1;f>=0;f--)for(var g=b.eq(f).data("KAT.Annotation.UUID")||[],h=0;h<g.length;h++)-1==c.indexOf(g[h])&&(c.push(g[h]),e.push(this.find(g[h])));return e},c.storage.Store.prototype.updateReferences=function(){var a=this;jQuery.map(this.annotations,function(b){jQuery.map(b.concept.fields,function(d){d.type===c.model.Field.types.reference&&jQuery.map(b.values[d.value],function(c,e){"string"==typeof c&&(b.values[d.value][e]=a.find(c))})})})},c.storage.Store.prototype.toRDF=function(){var a=this,b=d(c.rdf.create("rdf:RDF")).attr("xmlns:kat",c.rdf.kat_namespace).attr("xmlns:rdf",c.rdf.rdf_namespace),e="kat_run";b.append(d(c.rdf.create("rdf:Description")).append(c.rdf.attr(d(c.rdf.create("kat:annotation")),"rdf:nodeID",e)),c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",e).append(c.rdf.attr(d(c.rdf.create("rdf:type")),"rdf:resource","kat:run"),c.rdf.attr(d("<kat:date />").text((new Date).toISOString()),"rdf:datatype","xs:dateTime"),d("<kat:tool>").text("KAT"),d("<kat:runid>").text("0")));var f={};jQuery.each(this.annotations,function(g,h){var i=h.concept.KAnnSpec;f[i.rdf_nodeid]||(f[i.rdf_nodeid]=!0,i.xml.find("annotation").each(function(){d.each(this.attributes,function(a,c){var d=c.name,e=c.value;d.startsWith("xmlns:")&&b.attr(d,e)})}),b.append(d(c.rdf.create("rdf:Description")).append(c.rdf.attr(d(c.rdf.create("kat:annotation")),"rdf:nodeID",i.rdf_nodeid)),c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",i.rdf_nodeid).append(c.rdf.attr(d("<rdf:type>"),"rdf:resource","kat:kannspec"),d("<kat:kannspec-name>").text(i.name),d("<kat:kannspec-URI>").text(i.url)))),b.append(d(h.toRDF(a.docURL,e)).children())});var g=b.get(0).outerHTML;return console.log(g),g},c.storage.Store.prototype.addFromRDF=function(a){var b=this,d=jQuery(a),e=jQuery("rdf\\:Description",d).has("kat\\:annotates").map(function(){var a=c.storage.Annotation.fromRDF(d,jQuery(this).attr("rdf:nodeId"),b);return b.annotations.push(a),a}).toArray();return this.updateReferences(),e},c.storage.Store.prototype.showExportDialog=function(){var a=this.toRDF(),b=d("<textarea rows='20' readonly='readonly'>").addClass("form-control").text(a),e=c.gui.dialog("Export Annotations","",["OK"],function(){this.close()});e.$content.append(d("<form>").addClass("form").append(b)),b.focus(function(){b.select().mouseup(function(){return b.unbind("mouseup"),!1})}),b.click(function(){b.focus()}).click()},c.storage.Store.prototype.showImportDialog=function(){for(var a=prompt("Paste annotations to import here: "),b=this.addFromRDF(jQuery(a).get(0)),c=0;c<b.length;c++)b[c].draw()},c.storage.Store.Selection2UUID=function(a){return"cse("+a.container+","+a.start+","+a.end+")"},c.storage.Store.UUID2Selection=function(a){var b="cse(",c=")",d=a.substring(0,b.length),e=a.substring(a.length-c.length);return d!==b||e!==c?!1:(a=a.substring(b.length,a.length-c.length),a=a.split(","),3!==a.length?!1:{container:a[0],start:a[1],end:a[2],startOffset:0,endOffset:0})},c.storage.Annotation=function(a,b,c,d,e){this.store=a;var f=e||"KAT_"+(new Date).getTime()+"_"+Math.floor(1e4*Math.random());if(this.store.find(f))throw new Error("Annotation with given uuid already exists. ");this.uuid=f,this.selection=b,this.concept=c,d="undefined"!=typeof d?d:c.getDefault(),this.values=d},c.storage.Annotation.prototype["delete"]=function(){this.undraw();for(var a=0;a<this.store.annotations.length;a++)if(this.store.annotations[a].uuid==this.uuid){this.store.annotations.splice(a,1);break}},c.storage.Annotation.prototype.draw=function(){var a=this,b=this.store.gui.getRange(this.selection),e=this.concept.displayColour,f=this.concept.name;b.addClass(f).each(function(){-1!=this.namespaceURI.indexOf("MathML")?d(this).attr("mathbackground",e):d(this).css("background-color",e)}).each(function(){function b(a){for(var b,c=[],d=/{([^}]+)}/g;(b=d.exec(a))?!0:!1;)c.push(b[1]);return c}var e=d(this),f=e.data("KAT.Annotation.UUID")||[];f.push(a.uuid);var g=b(a.concept.display),h=document.createElement("div");h.innerHTML=a.concept.display;var i,j=h.textContent||h.innerText||"",k=function(a){return a[0].toUpperCase()+a.slice(1).toLowerCase()};d.each(g,function(b,d){switch(a.concept.fields[b].type){case c.model.Field.types.reference:break;case c.model.Field.types.select:i=a.values[d][0].value||"",j=j.replace("{"+g[b]+"}",i);break;default:i=a.values[d]||a.values[k(d)]||"",j=j.replace("{"+g[b]+"}",i)}}),e.attr("title",j),e.data("KAT.Annotation.UUID",f)})},c.storage.Annotation.fromRDF=function(a,b,d){var e,f=jQuery(a),g=function(a,b){var d=c.rdf.buildNameSpace(a,f.get(0));return b?d.replace(new RegExp(":","g"),"\\:"):d},h=c.rdf.findById(f,b),i=h.find("kat\\:annotates").attr("rdf:resource");if(i.substring(0,d.docURL.length+1)!=d.docURL+"#"){if(-1==i.indexOf("#"))throw new Error("Malformed RDF: Unable to parse selection URL. ");console.log("Currently loaded document does not match RDF annotation, loading it anyways ... "),e=decodeURIComponent(i.indexOf("#")+1)}else e=decodeURIComponent(i.substring(d.docURL.length+1));var j=c.storage.Store.UUID2Selection(e),k=c.rdf.findById(f,h.find("kat\\:kannspec").attr("rdf:nodeID"));if(1!==k.length)throw new Error("Malformed RDF: Unable to find KAnnSpec. ");var l=k.find("kat\\:kannspec-uri").text(),m=k.find("kat\\:kannspec-name").text();if(!m)throw new Error("Malformed RDF: Missing <kat:kannspec-name>");var n=d.collection.getKAnnSpec(m);if(!n)throw new Error("KAnnSpec '"+m+"' not loaded. ");

l&&l===n.url||console.warn("Warning: KAnnSpec URL does not match. "),n.rdf_nodeid=h.find("kat\\:kannspec").attr("rdf:nodeID");var o=h.find("kat\\:concept").text();if(!o)throw new Exception("Malformed RDF: Missing <kat:concept>");var p=n.getConcept(o);if(!p)throw new Error("Concept '"+o+"' not found inside '"+m+"'");var q={};jQuery.each(p.fields,function(a,b){var d=[];b.type==c.model.Field.types.text?h.find(g(b.rdf_pred,!0)).each(function(){d.push(jQuery(this).text())}):b.type==c.model.Field.types.reference?h.find(g(b.rdf_pred,!0)).each(function(){d.push(jQuery(this).attr("rdf:nodeID"))}):b.type==c.model.Field.types.select&&h.find(g(b.rdf_pred,!0)).each(function(){for(var a=jQuery(this).attr("rdf:resource"),c=0;c<b.validation.length;c++)if(b.validation[c].rdf_obj===a||b.validation[c].value===a)return void d.push(b.validation[c]);throw new Error("Option '"+a+"' not found inside '"+m+"'")}),q[b.value]=d});var r=new c.storage.Annotation(d,j,p,q,b);return r},c.storage.Annotation.prototype.flash=function(){this.store.gui.getRange(this.selection).stop().animate({backgroundColor:"red"},1500,function(){d(this).css("background-color","")})},c.storage.Annotation.prototype.edit=function(a){c.sidebar.generateAnnotationForm(a,function(a,b,c,d){return d.values=c,d.undraw(),d.draw(),d.flash(),d},this,this.selection,this.concept)},c.storage.Annotation.prototype.undraw=function(){var a=this,b=this.store.gui.getRange(this.selection);b.removeClass("KAT-selection").each(function(){var b=d(this),c=d(this).data("KAT.Annotation.UUID")||[],e=c.indexOf(a.uuid);~e&&(c.splice(e,1),b.data("KAT.Annotation.UUID",c))})},c.storage.Annotation.prototype.toRDF=function(a,b){var e=this,f=this.concept,g=a+"#"+encodeURIComponent(c.storage.Store.Selection2UUID(this.selection)),h=d(c.rdf.create("rdf:RDF")),i=c.rdf.attr(d(c.rdf.create("rdf:Description")),"rdf:nodeID",this.uuid).appendTo(h).append(c.rdf.attr(d(c.rdf.create("kat:run")),"rdf:nodeID",b),c.rdf.attr(d(c.rdf.create("kat:kannspec")),"rdf:nodeID",f.KAnnSpec.rdf_nodeid),d(c.rdf.create("kat:concept")).text(f.name),c.rdf.attr(d(c.rdf.create("kat:type")),"rdf:resource",f.rdf_type),c.rdf.attr(d(c.rdf.create("kat:annotates")),"rdf:resource",g));return jQuery.each(f.fields,function(a,b){var g=e.values[b.value],h=jQuery.isArray(g)?g:[g];jQuery.each(h,function(a,e){var g=d(c.rdf.create(c.rdf.buildNameSpace(b.rdf_pred,f.KAnnSpec.xml))).appendTo(i);b.type==c.model.Field.types.text?g.text(e):b.type==c.model.Field.types.reference?c.rdf.attr(g,"rdf:nodeID",e.uuid):b.type==c.model.Field.types.select&&c.rdf.attr(g,"rdf:resource",e.rdf_obj?e.rdf_obj:e.value)})}),h.get(0)},c.module={info:{identifier:"KAT.module",title:"KAT module",author:"The KWARC group",description:"A module for KAT",url:"http://kwarc.github.io/KAT",version:"2.0",dependencies:[],externals:{js:[],css:[]},async:!1,hasCleanNamespace:!1},init:function(a,b,d){var e;b instanceof c.model.KAnnSpecCollection?e=b:(e=new c.model.KAnnSpecCollection,e.addNewKAnnSpec(b[0],b[1])),this.gui=new c.gui(a.element,e),this.store=new c.storage.Store(this.gui,d),a.element.tooltip(),c.sidebar.init(this.store),e.init(),e.assignDisplayColour()},contextMenuEntries:function(a){var b=this,e="Delete Annotation",f="Highlight Annotation",g="Edit Annotation",h="Enable Annotation Mode",i="Enable Reading Mode",j="Import Annotations",k="Export Annotations",l={},m=function(a){a?l[i]=function(){c.sidebar.toggleAnnotationMode()}:l[h]=function(){c.sidebar.toggleAnnotationMode()},l[j]=b.store.showImportDialog.bind(b.store),l[k]=b.store.showExportDialog.bind(b.store)};if(c.sidebar.annotationMode){var n;try{n=this.gui.getSelection()}catch(o){}if(!n||n.isEmpty){m(!0);var p=this.store.findfromElement(a);0!==p.length&&(l={},l[e]={},l[f]={},l[g]={},d.each(p,function(a,c){l[e][c.uuid]=function(){c["delete"]()},l[f][c.uuid]=function(){c.flash()},l[g][c.uuid]=function(){c.edit(b)}}))}else(n.start!=n.end||n.startOffset!=n.endOffset)&&d.each(this.gui.collection.findConcepts(),function(a,d){l[d.getFullName()]=function(){c.sidebar.generateAnnotationForm(b,b.store.addNew.bind(b.store),void 0,n,d)}})}else m(!1);return l}},JOBAD.modules.register(c.module)}({},function(){return this}());
//# sourceMappingURL=KAT.min.js.map